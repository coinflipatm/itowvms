<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iTow Impound Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
        }
        .navbar-brand img {
            height: 40px;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            padding-top: 20px;
            position: fixed;
            width: 250px;
            z-index: 100;
        }
        .sidebar a {
            color: #ffffff;
            padding: 10px 20px;
            display: block;
            text-decoration: none;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .sidebar a.active {
            background-color: #007bff;
        }
        .content {
            margin-left: 250px;
            padding: 20px;
        }
        .vehicle-table th {
            cursor: pointer;
        }
        .vehicle-table th.sorted-asc::after {
            content: ' ↑';
        }
        .vehicle-table th.sorted-desc::after {
            content: ' ↓';
        }
        .status-label {
            padding: 5px 10px;
            border-radius: 5px;
            color: #fff;
            font-size: 0.8rem;
            display: inline-block;
            text-align: center;
            min-width: 120px;
        }
        .status-new { background-color: #007bff; }
        .status-top { background-color: #17a2b8; }
        .status-tr52 { background-color: #28a745; }
        .status-tr208 { background-color: #28a745; }
        .status-auction { background-color: #ffc107; color: #000; }
        .status-scrap { background-color: #dc3545; }
        .status-released { background-color: #6c757d; }
        .modal-body pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .photo-preview img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            cursor: pointer;
        }
        .timeline {
            border-left: 2px solid #007bff;
            padding-left: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .timeline-item {
            margin-bottom: 20px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            width: 12px;
            height: 12px;
            background: #007bff;
            border-radius: 50%;
            position: absolute;
            left: -26px;
            top: 5px;
        }
        .timeline-item .badge {
            width: 100px;
            text-align: center;
        }
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h3 {
            font-size: 1.5rem;
            color: #343a40;
        }
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .contacts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .contact-card {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .document-item {
            display: flex;
            align-items: center;
            padding: 5px 0;
        }
        .document-item i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        .document-date {
            color: #6c757d;
            font-size: 0.8rem;
            margin-left: auto;
        }
        .notification-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .notification-item.urgent {
            border-left: 4px solid #dc3545;
        }
        .note-field {
            resize: vertical;
            min-height: 100px;
        }
        .action-links a {
            margin-right: 10px;
            text-decoration: none;
        }
        .days-counter {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 5px 10px;
            font-weight: bold;
            display: inline-block;
        }
        .days-counter.critical {
            background-color: #f8d7da;
            color: #721c24;
        }
        .days-counter.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                width: 100%;
                min-height: auto;
            }
            .content {
                margin-left: 0;
            }
        }
        .fullscreen-photo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .fullscreen-photo img {
            max-width: 90%;
            max-height: 90%;
        }
        .fullscreen-photo .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* Timeline visualization styles */
        .timeline-visual {
            position: relative;
            margin: 40px 0;
            padding: 20px 0;
            border-top: 2px solid #dee2e6;
        }

        .timeline-marker {
            position: absolute;
            top: -10px;
            padding: 5px 10px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            transform: translateX(-50%);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .timeline-marker.past {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .timeline-marker.current {
            border-color: #007bff;
            background-color: #cce5ff;
            color: #004085;
            font-weight: bold;
        }

        .timeline-marker.future {
            border-color: #6c757d;
            color: #6c757d;
        }

        .timeline-marker.critical {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .timeline-today {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            border-left: 2px dashed #dc3545;
            height: 40px;
        }

        .timeline-today-label {
            position: absolute;
            top: -40px;
            transform: translateX(-50%);
            color: #dc3545;
            font-weight: bold;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <!-- Fixed Sidebar Navigation with Proper Status Types -->
    <div class="sidebar">
        <a class="navbar-brand text-white" href="/"><img src="/static/logo.png" alt="iTow Logo"> iTow Manager</a>
        <hr class="bg-light">
        <a href="#" data-tab="active" class="active"><i class="fas fa-car"></i> Active Vehicles</a>
        <a href="#" data-tab="New"><i class="fas fa-plus"></i> New</a>
        <a href="#" data-tab="TOP_Generated"><i class="fas fa-file-alt"></i> TOP Generated</a>
        <a href="#" data-tab="TR52_Ready"><i class="fas fa-check"></i> TR52 Ready</a>
        <a href="#" data-tab="TR208_Ready"><i class="fas fa-check"></i> TR208 Ready</a>
        <a href="#" data-tab="Ready_for_Auction"><i class="fas fa-gavel"></i> Ready for Auction</a>
        <a href="#" data-tab="Ready_for_Scrap"><i class="fas fa-trash"></i> Ready for Scrap</a>
        <a href="#" data-tab="Completed"><i class="fas fa-archive"></i> Completed</a>
        <a href="#" data-tab="notifications"><i class="fas fa-bell"></i> Notifications <span id="notification-count" class="notification-badge d-none">0</span></a>
        <a href="#" data-tab="contacts"><i class="fas fa-address-book"></i> Jurisdiction Contacts</a>
        <a href="#" data-tab="statistics"><i class="fas fa-chart-bar"></i> Statistics</a>
        <a href="#" data-tab="compliance"><i class="fas fa-shield-alt"></i> Compliance</a>
        <a href="/profile" data-tab="profile"><i class="fas fa-user"></i> Profile</a>
        <a href="/logs" data-tab="logs"><i class="fas fa-history"></i> System Logs</a>
        <!-- Admin links will be added dynamically by navbar.js if the user is an admin -->
    </div>
    
    <!-- Main Content -->
    <div class="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 id="page-title">Active Vehicles</h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal"><i class="fas fa-plus"></i> Add Vehicle</button>
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#scrapeModal"><i class="fas fa-sync"></i> Import Vehicles</button>
                <a href="/api/compliance-report" class="btn btn-success"><i class="fas fa-download"></i> Compliance Report</a>
            </div>
        </div>

        <!-- Workflow Counts -->
        <div class="row mb-4" id="workflow-counts">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Overdue Tasks</h5>
                        <p class="card-text"><span id="overdue-count" class="badge bg-danger">0</span> vehicles</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Due Today</h5>
                        <p class="card-text"><span id="due-today-count" class="badge bg-warning text-dark">0</span> vehicles</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Ready for Action</h5>
                        <p class="card-text"><span id="ready-count" class="badge bg-success">0</span> vehicles</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Pending Notifications</h5>
                        <p class="card-text"><span id="notifications-count" class="badge bg-primary">0</span> notifications</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upcoming Actions Dashboard -->
        <div class="row mb-4" id="upcoming-actions-dashboard">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-calendar-check"></i> Upcoming Actions Dashboard</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Vehicle</th>
                                        <th>Current Status</th>
                                        <th>Next Action</th>
                                        <th>Due Date</th>
                                        <th>Days Left</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-actions-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Table -->
        <div id="vehicles-container">
            <div class="table-responsive">
                <table class="table table-striped vehicle-table">
                    <thead>
                        <tr>
                            <th data-sort="towbook_call_number">Call Number</th>
                            <th data-sort="complaint_number">Complaint #</th>
                            <th data-sort="vin">VIN</th>
                            <th data-sort="make">Make</th>
                            <th data-sort="model">Model</th>
                            <th data-sort="year">Year</th>
                            <th data-sort="color">Color</th>
                            <th data-sort="tow_date">Tow Date</th>
                            <th data-sort="jurisdiction">Jurisdiction</th>
                            <th data-sort="status">Status</th>
                            <th>Timeline</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vehicle-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Notifications Container -->
        <div id="notifications-container" class="d-none">
            <div class="row mb-3">
                <div class="col">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> The following notifications need to be sent. Select a notification and choose how to send it.
                    </div>
                </div>
            </div>
            <div id="pending-notifications-list"></div>
        </div>

        <!-- Contacts Container -->
        <div id="contacts-container" class="d-none">
            <div class="row mb-3">
                <div class="col">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                        <i class="fas fa-plus"></i> Add New Contact
                    </button>
                </div>
            </div>
            <div class="row contacts-list" id="contacts-list"></div>
        </div>

        <!-- Statistics Container -->
        <div id="statistics-container" class="d-none"></div>

        <!-- Compliance Container -->
        <div id="compliance-container" class="d-none">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-clipboard-check"></i> Compliance Reports</h5>
                        </div>
                        <div class="card-body">
                            <p>Download compliance reports for documentation and record-keeping.</p>
                            <div class="d-grid gap-2">
                                <a href="/api/compliance-report" class="btn btn-primary">
                                    <i class="fas fa-file-csv"></i> Download CSV Report
                                </a>
                                <a href="/api/compliance-report/pdf" class="btn btn-primary">
                                    <i class="fas fa-file-pdf"></i> Download PDF Report
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-bell"></i> Pending Notifications</h5>
                        </div>
                        <div class="card-body">
                            <p>View and send required notifications to maintain compliance with MCL 257.252.</p>
                            <div class="d-grid">
                                <button class="btn btn-primary" id="view-pending-notifications-btn">
                                    <i class="fas fa-bell"></i> View Pending Notifications
                                    <span class="badge bg-danger" id="compliance-notification-count">0</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-tasks"></i> Michigan Abandoned Vehicle Compliance Checklist</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> MCL 257.252 Compliance Overview:</h6>
                                <p>This checklist ensures your abandoned vehicle processing complies with Michigan law. Follow these steps for each abandoned vehicle.</p>
                            </div>
                            
                            <h6 class="mt-4 mb-3">Initial Tow & Notification Phase</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Requirement</th>
                                        <th width="20%">Timeline</th>
                                        <th width="25%">Required Documentation</th>
                                        <th width="20%">Legal Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Submit TOP Form to Police</strong><br>
                                            Notify police agency with jurisdiction that vehicle has been towed
                                        </td>
                                        <td>Within 24 hours of tow</td>
                                        <td>
                                            - TOP Form (Record of Abandoned Vehicle)<br>
                                            - Proof of delivery
                                        </td>
                                        <td>MCL 257.252a(9)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Police Notification to Owner & SOS</strong><br>
                                            Police must notify registered owner and secured parties
                                        </td>
                                        <td>Within 7 days of receiving TOP form</td>
                                        <td>None required from towing company (police responsibility)</td>
                                        <td>MCL 257.252a(5)(b)</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <h6 class="mt-4 mb-3">Redemption & Title Processing Phase</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Requirement</th>
                                        <th width="20%">Timeline</th>
                                        <th width="25%">Required Documentation</th>
                                        <th width="20%">Legal Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Owner Redemption Period</strong><br>
                                            Vehicle must be made available for owner redemption
                                        </td>
                                        <td>20 days from police notification</td>
                                        <td>
                                            - Release records (if redeemed)<br>
                                            - Receipt for fees collected
                                        </td>
                                        <td>MCL 257.252a(5)(g)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Secured Party Redemption Period</strong><br>
                                            Vehicle must be made available for secured party redemption
                                        </td>
                                        <td>30 days from police notification</td>
                                        <td>
                                            - Release records (if redeemed)<br>
                                            - Receipt for fees collected
                                        </td>
                                        <td>MCL 257.252b(7)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>TR52 Form Processing</strong><br>
                                            For vehicles going to auction
                                        </td>
                                        <td>After 20-day redemption period</td>
                                        <td>
                                            - TR52 Form<br>
                                            - Receipt or proof of submission
                                        </td>
                                        <td>MCL 257.252a(6)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>TR208 Form Processing</strong><br>
                                            For scrap vehicles (7+ years old, inoperable, extensively damaged)
                                        </td>
                                        <td>After 20-day redemption period (min. 27 days from tow)</td>
                                        <td>
                                            - TR208 Form<br>
                                            - Vehicle condition documentation<br>
                                            - Photos of vehicle
                                        </td>
                                        <td>MCL 257.252b(1)</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <h6 class="mt-4 mb-3">Disposition Phase</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Requirement</th>
                                        <th width="20%">Timeline</th>
                                        <th width="25%">Required Documentation</th>
                                        <th width="20%">Legal Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Auction Notice Publication</strong><br>
                                            Public notice of auction in newspaper
                                        </td>
                                        <td>At least 5 days before auction</td>
                                        <td>
                                            - Copy of newspaper advertisement<br>
                                            - Publication date documentation
                                        </td>
                                        <td>MCL 257.252g(1)</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Auction</strong><br>
                                            Public auction of vehicle
                                        </td>
                                        <td>After TR52 processing (recommended minimum 40 days from tow)</td>
                                        <td>
                                            - Auction record<br>
                                            - Buyer information<br>
                                            - Sales price documentation<br>
                                            - Bill of sale
                                        </td>
                                        <td>MCL 257.252g</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Scrap Processing</strong><br>
                                            Disposal of TR208 vehicles
                                        </td>
                                        <td>After TR208 approval (minimum 27 days from tow)</td>
                                        <td>
                                            - Documentation of scrapping<br>
                                            - Photos of vehicle prior to scrapping<br>
                                            - Receipt from scrap processor
                                        </td>
                                        <td>MCL 257.252b</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Release Notification</strong><br>
                                            Notify police of disposition (redemption, auction, scrap, transfer)
                                        </td>
                                        <td>Within 24 hours of disposition</td>
                                        <td>
                                            - Release notification form<br>
                                            - Proof of delivery
                                        </td>
                                        <td>MCL 257.252a(10)</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <h6 class="mt-4 mb-3">Record Keeping Requirements</h6>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Requirement</th>
                                        <th width="20%">Timeline</th>
                                        <th width="25%">Required Documentation</th>
                                        <th width="20%">Legal Reference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <strong>Record Retention</strong><br>
                                            Maintain complete records of all abandoned vehicles
                                        </td>
                                        <td>At least 2 years from disposition</td>
                                        <td>
                                            - All forms and notices<br>
                                            - Photos of vehicle<br>
                                            - Disposition records<br>
                                            - Financial records
                                        </td>
                                        <td>MCL 257.252k</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <strong>Financial Accounting</strong><br>
                                            Track fees, sale proceeds, and disposition of funds
                                        </td>
                                        <td>Ongoing</td>
                                        <td>
                                            - Itemized fee records<br>
                                            - Sale proceeds documentation<br>
                                            - Distribution of excess proceeds
                                        </td>
                                        <td>MCL 257.252g(3)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-cogs"></i> System Status</h5>
                        </div>
                        <div class="card-body">
                            <div id="compliance-status"></div>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>System Diagnostics</h6>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-group">
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Database Status
                                                    <span class="badge bg-success">Connected</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    PDF Generator
                                                    <span class="badge bg-success">Operational</span>
                                                </li>
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    Automated Checks
                                                    <span class="badge bg-success">Running</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6>System Actions</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-info" id="run-status-checks-btn">
                                                    <i class="fas fa-sync"></i> Run Status Checks
                                                </button>
                                                <button class="btn btn-warning" id="fix-vehicle-statuses-btn">
                                                    <i class="fas fa-wrench"></i> Fix Vehicle Statuses
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Add New Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-vehicle-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="towbook_call_number" class="form-label">Call Number</label>
                                <input type="text" class="form-control" id="towbook_call_number" name="towbook_call_number" placeholder="Auto-generated if blank">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="complaint_number" class="form-label">Complaint Number</label>
                                <input type="text" class="form-control" id="complaint_number" name="complaint_number" placeholder="Auto-generated if blank">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="vin" class="form-label">VIN</label>
                                <input type="text" class="form-control" id="vin" name="vin" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="make" class="form-label">Make</label>
                                <input type="text" class="form-control" id="make" name="make" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="model" class="form-label">Model</label>
                                <input type="text" class="form-control" id="model" name="model" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="year" class="form-label">Year</label>
                                <input type="text" class="form-control" id="year" name="year">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="color" class="form-label">Color</label>
                                <input type="text" class="form-control" id="color" name="color">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="plate" class="form-label">Plate</label>
                                <input type="text" class="form-control" id="plate" name="plate">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state" value="MI">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tow_date" class="form-label">Tow Date</label>
                                <input type="date" class="form-control" id="tow_date" name="tow_date" required value="">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tow_time" class="form-label">Tow Time</label>
                                <input type="time" class="form-control" id="tow_time" name="tow_time">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="requested_by" class="form-label">Requested By</label>
                                <input type="text" class="form-control" id="requested_by" name="requested_by" value="PROPERTY OWNER">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="jurisdiction" class="form-label">Jurisdiction</label>
                                <select class="form-control" id="jurisdiction" name="jurisdiction">
                                    <option value="detect">Auto-detect from location</option>
                                    <option value="Flint">Flint</option>
                                    <option value="Burton">Burton</option>
                                    <option value="Grand Blanc">Grand Blanc</option>
                                    <option value="Flushing">Flushing</option>
                                    <option value="Clio">Clio</option>
                                    <option value="Davison">Davison</option>
                                    <option value="Fenton">Fenton</option>
                                    <option value="Mt. Morris">Mt. Morris</option>
                                    <option value="Flint Township">Flint Township</option>
                                    <option value="Genesee Township">Genesee Township</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="case_number" class="form-label">Case Number</label>
                                <input type="text" class="form-control" id="case_number" name="case_number">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="officer_name" class="form-label">Officer Name</label>
                                <input type="text" class="form-control" id="officer_name" name="officer_name">
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_top" name="auto_top" checked>
                                    <label class="form-check-label" for="auto_top">
                                        Automatically generate TOP form
                                    </label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Vehicle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editVehicleModal" tabindex="-1" aria-labelledby="editVehicleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editVehicleModalLabel">Edit Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-vehicle-form">
                        <input type="hidden" id="edit-call-number" name="towbook_call_number">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-complaint_number" class="form-label">Complaint Number</label>
                                <input type="text" class="form-control" id="edit-complaint_number" name="complaint_number">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-vin" class="form-label">VIN</label>
                                <input type="text" class="form-control" id="edit-vin" name="vin">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-make" class="form-label">Make</label>
                                <input type="text" class="form-control" id="edit-make" name="make">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-model" class="form-label">Model</label>
                                <input type="text" class="form-control" id="edit-model" name="model">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-year" class="form-label">Year</label>
                                <input type="text" class="form-control" id="edit-year" name="year">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-color" class="form-label">Color</label>
                                <input type="text" class="form-control" id="edit-color" name="color">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-plate" class="form-label">Plate</label>
                                <input type="text" class="form-control" id="edit-plate" name="plate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-state" class="form-label">State</label>
                                <input type="text" class="form-control" id="edit-state" name="state">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-tow_date" class="form-label">Tow Date</label>
                                <input type="date" class="form-control" id="edit-tow_date" name="tow_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-tow_time" class="form-label">Tow Time</label>
                                <input type="time" class="form-control" id="edit-tow_time" name="tow_time">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-requested_by" class="form-label">Requested By</label>
                                <input type="text" class="form-control" id="edit-requested_by" name="requested_by">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="edit-location" name="location">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-jurisdiction" class="form-label">Jurisdiction</label>
                                <select class="form-control" id="edit-jurisdiction" name="jurisdiction">
                                    <option value="detect">Auto-detect from location</option>
                                    <option value="Flint">Flint</option>
                                    <option value="Burton">Burton</option>
                                    <option value="Grand Blanc">Grand Blanc</option>
                                    <option value="Flushing">Flushing</option>
                                    <option value="Clio">Clio</option>
                                    <option value="Davison">Davison</option>
                                    <option value="Fenton">Fenton</option>
                                    <option value="Mt. Morris">Mt. Morris</option>
                                    <option value="Flint Township">Flint Township</option>
                                    <option value="Genesee Township">Genesee Township</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-status" class="form-label">Status</label>
                                <select class="form-control" id="edit-status" name="status">
                                    <option value="New">New</option>
                                    <option value="TOP Generated">TOP Generated</option>
                                    <option value="TR52 Ready">TR52 Ready</option>
                                    <option value="TR208 Ready">TR208 Ready</option>
                                    <option value="Ready for Auction">Ready for Auction</option>
                                    <option value="Ready for Scrap">Ready for Scrap</option>
                                    <option value="Released">Released</option>
                                    <option value="Auctioned">Auctioned</option>
                                    <option value="Scrapped">Scrapped</option>
                                    <option value="Transferred">Transferred</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-officer_name" class="form-label">Officer Name</label>
                                <input type="text" class="form-control" id="edit-officer_name" name="officer_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-case_number" class="form-label">Case Number</label>
                                <input type="text" class="form-control" id="edit-case_number" name="case_number">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Vehicle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="vehicleDetailsModal" tabindex="-1" aria-labelledby="vehicleDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vehicleDetailsModalLabel">Vehicle Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="vehicleDetailsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="photos-tab" data-bs-toggle="tab" data-bs-target="#photos" type="button" role="tab" aria-controls="photos" aria-selected="false">Photos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="communications-tab" data-bs-toggle="tab" data-bs-target="#communications" type="button" role="tab" aria-controls="communications" aria-selected="false">Communications</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-controls="documents" aria-selected="false">Documents</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-tab-content" type="button" role="tab" aria-controls="timeline-tab-content" aria-selected="false">Timeline</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab" aria-controls="actions" aria-selected="false">Actions</button>
                        </li>
                    </ul>
                    <div class="tab-content mt-3" id="vehicleDetailsTabContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h5>Vehicle Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="vehicle-info-card"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h5>Status Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="status-info-card"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>All Vehicle Data</h5>
                                        </div>
                                        <div class="card-body">
                                            <pre id="vehicle-info" class="small"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Photos Tab -->
                        <div class="tab-pane fade" id="photos" role="tabpanel" aria-labelledby="photos-tab">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5>Vehicle Photos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="photo-preview" id="photo-preview"></div>
                                    <form id="photo-upload-form" enctype="multipart/form-data" class="mt-3">
                                        <input type="hidden" id="photo-call-number">
                                        <div class="input-group">
                                            <input type="file" id="photo-file" class="form-control" accept="image/*">
                                            <button type="submit" class="btn btn-primary">Upload Photo</button>
                                        </div>
                                        <small class="form-text text-muted">Upload photos of the vehicle for documentation purposes.</small>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Communications Tab -->
                        <div class="tab-pane fade" id="communications" role="tabpanel" aria-labelledby="communications-tab">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5>Police Communications</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Notes</th>
                                                    <th>Recipient</th>
                                                    <th>Method</th>
                                                </tr>
                                            </thead>
                                            <tbody id="police-logs"></tbody>
                                        </table>
                                    </div>
                                    <form id="police-log-form" class="mt-3">
                                        <input type="hidden" id="log-call-number">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="communication_type" class="form-label">Type</label>
                                                <select class="form-control" id="communication_type">
                                                    <option value="TOP Notification">TOP Notification</option>
                                                    <option value="TR52 Request">TR52 Request</option>
                                                    <option value="TR52 Receipt">TR52 Receipt</option>
                                                    <option value="TR208 Request">TR208 Request</option>
                                                    <option value="TR208 Receipt">TR208 Receipt</option>
                                                    <option value="Auction Ad Receipt">Auction Ad Receipt</option>
                                                    <option value="Release Notification">Release Notification</option>
                                                    <option value="Certified Mail">Certified Mail</option>
                                                    <option value="Phone Call">Phone Call</option>
                                                    <option value="Email">Email</option>
                                                    <option value="In Person">In Person</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="communication_date" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="communication_date" value="">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="communication_recipient" class="form-label">Recipient</label>
                                                <input type="text" class="form-control" id="communication_recipient">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="communication_method" class="form-label">Method</label>
                                                <select class="form-control" id="communication_method">
                                                    <option value="email">Email</option>
                                                    <option value="fax">Fax</option>
                                                    <option value="mail">Mail</option>
                                                    <option value="phone">Phone</option>
                                                    <option value="in-person">In Person</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="communication_notes" class="form-label">Notes</label>
                                            <textarea class="form-control note-field" id="communication_notes" rows="4"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Communication Log</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Documents Tab -->
                        <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5>Vehicle Documents</h5>
                                </div>
                                <div class="card-body">
                                    <div id="document-list" class="mb-3"></div>
                                    <form id="document-upload-form" enctype="multipart/form-data" class="mt-3">
                                        <input type="hidden" id="document-call-number">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="document-type" class="form-label">Document Type</label>
                                                <select class="form-control" id="document-type">
                                                    <option value="TR52">TR52 Form</option>
                                                    <option value="TR208">TR208 Form</option>
                                                    <option value="Title">Vehicle Title</option>
                                                    <option value="Police Report">Police Report</option>
                                                    <option value="Auction Receipt">Auction Receipt</option>
                                                    <option value="Scrap Receipt">Scrap Receipt</option>
                                                    <option value="Certified Mail">Certified Mail Receipt</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="document-file" class="form-label">Document File</label>
                                                <input type="file" id="document-file" class="form-control" accept=".pdf,.doc,.docx,.txt">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Upload Document</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timeline Tab -->
                        <div class="tab-pane fade" id="timeline-tab-content" role="tabpanel" aria-labelledby="timeline-tab">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5>Compliance Timeline</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <p><strong>Michigan Vehicle Custody Timeline (MCL 257.252):</strong></p>
                                        <ul>
                                            <li><strong>24 hours:</strong> TOP form must be submitted to police</li>
                                            <li><strong>7 days:</strong> Police agency must notify owner & SOS</li>
                                            <li><strong>20 days:</strong> Owner redemption period</li>
                                            <li><strong>30 days:</strong> Secured party redemption period</li>
                                            <li><strong>27 days:</strong> TR208 scrap timeline (7 days + 20 days)</li>
                                            <li><strong>40 days:</strong> Safe auction timeline from tow date</li>
                                        </ul>
                                    </div>
                                    <div id="vehicle-timeline-visual" class="mb-4"></div>
                                    <div class="timeline" id="vehicle-timeline"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions Tab -->
                        <div class="tab-pane fade" id="actions" role="tabpanel" aria-labelledby="actions-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h5>Documentation Actions</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-primary" id="generate-top-btn">Generate TOP Form</button>
                                                <button class="btn btn-primary" id="generate-tr52-btn">Generate TR52 Form</button>
                                                <button class="btn btn-primary" id="check-tr208-btn">Check TR208 Eligibility</button>
                                                <button class="btn btn-primary" id="generate-release-btn">Generate Release Notice</button>
                                                <button class="btn btn-primary" id="upload-tr52-btn">Upload Amended TR52</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h5>Process Actions</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-success" id="mark-tr52-ready-btn">Mark TR52 Ready</button>
                                                <button class="btn btn-success" id="make-decision-btn">Make Auction/Scrap Decision</button>
                                                <button class="btn btn-success" id="calculate-fees-btn">Calculate Storage Fees</button>
                                                <button class="btn btn-success" id="certified-mail-btn">Generate Certified Mail #</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-header bg-danger text-white">
                                            <h5>Danger Zone</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-outline-danger" id="delete-vehicle-btn">Delete Vehicle</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addContactModalLabel">Add Jurisdiction Contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contact-form">
                        <input type="hidden" id="contact-id" name="id">
                        <div class="mb-3">
                            <label for="contact-jurisdiction" class="form-label">Jurisdiction</label>
                            <input type="text" class="form-control" id="contact-jurisdiction" name="jurisdiction" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact-name" class="form-label">Contact Name</label>
                            <input type="text" class="form-control" id="contact-name" name="contact_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="contact-phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="contact-phone" name="phone">
                        </div>
                        <div class="mb-3">
                            <label for="contact-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="contact-email" name="email">
                        </div>
                        <div class="mb-3">
                            <label for="contact-fax" class="form-label">Fax</label>
                            <input type="text" class="form-control" id="contact-fax" name="fax">
                        </div>
                        <div class="mb-3">
                            <label for="contact-address" class="form-label">Address</label>
                            <textarea class="form-control" id="contact-address" name="address" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="contact-method" class="form-label">Preferred Contact Method</label>
                            <select class="form-control" id="contact-method" name="preferred_method">
                                <option value="email">Email</option>
                                <option value="fax">Fax</option>
                                <option value="mail">Mail</option>
                                <option value="phone">Phone</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="contact-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="contact-notes" name="notes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Contact</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Vehicles Modal -->
    <div class="modal fade" id="scrapeModal" tabindex="-1" aria-labelledby="scrapeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scrapeModalLabel">Import Vehicles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scrape-form">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="auto_determine_jurisdiction" checked>
                            <label class="form-check-label" for="auto_determine_jurisdiction">Auto-determine jurisdiction from location</label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="headless" checked>
                            <label class="form-check-label" for="headless">Run in Background</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Start Import</button>
                    </form>
                    <div id="scrape-progress" class="mt-3">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar">0%</div>
                        </div>
                        <p id="progress-text">Not running</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Release Notice Modal -->
    <div class="modal fade" id="releaseNoticeModal" tabindex="-1" aria-labelledby="releaseNoticeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="releaseNoticeModalLabel">Generate Release Notice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="release-notice-form">
                        <input type="hidden" id="release-call-number">
                        <div class="mb-3">
                            <label for="release_reason" class="form-label">Release Reason</label>
                            <select class="form-control" id="release_reason" required>
                                <option value="Owner Redeemed">Owner Redeemed</option>
                                <option value="Auctioned">Auctioned</option>
                                <option value="Scrapped">Scrapped</option>
                                <option value="Title Transfer">Title Transfer to Tow Company</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="recipient" class="form-label">Recipient</label>
                            <input type="text" class="form-control" id="recipient" required>
                        </div>
                        <div class="mb-3">
                            <label for="release_date" class="form-label">Release Date</label>
                            <input type="date" class="form-control" id="release_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="release_time" class="form-label">Release Time</label>
                            <input type="time" class="form-control" id="release_time" required>
                        </div>
                        <div id="auction-fields" style="display: none;">
                            <div class="mb-3">
                                <label for="sale_amount" class="form-label">Sale Amount</label>
                                <input type="number" class="form-control" id="sale_amount" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="fees" class="form-label">Fees</label>
                                <input type="number" class="form-control" id="fees" step="0.01">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notification-method" class="form-label">Send Notification Via</label>
                            <select class="form-control" id="notification-method">
                                <option value="none">Do Not Send</option>
                                <option value="email">Email</option>
                                <option value="fax">Fax</option>
                                <option value="mail">Mail</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate Notice</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Decision Modal -->
    <div class="modal fade" id="decisionModal" tabindex="-1" aria-labelledby="decisionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="decisionModalLabel">Make Decision</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="decision-form">
                        <input type="hidden" id="decision-call-number">
                        <div class="mb-3">
                            <label class="form-label">Choose Disposition</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decision" id="decision-auction" value="auction" checked>
                                <label class="form-check-label" for="decision-auction">
                                    Send to Auction
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="decision" id="decision-scrap" value="scrap">
                                <label class="form-check-label" for="decision-scrap">
                                    Send to Scrap
                                </label>
                            </div>
                        </div>
                        <div class="mb-3" id="auction-date-field">
                            <label for="auction-date" class="form-label">Auction Date</label>
                            <input type="date" class="form-control" id="auction-date">
                            <small class="form-text text-muted">Leave blank to use next scheduled auction date.</small>
                        </div>
                        <div class="mb-3" id="scrap-value-field" style="display: none;">
                            <label for="scrap-value" class="form-label">Estimated Scrap Value</label>
                            <input type="number" class="form-control" id="scrap-value" step="0.01" value="0.00">
                        </div>
                        <button type="submit" class="btn btn-primary">Confirm Decision</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload TR52 Modal -->
    <div class="modal fade" id="uploadTR52Modal" tabindex="-1" aria-labelledby="uploadTR52ModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadTR52ModalLabel">Upload Amended TR52</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-tr52-form" enctype="multipart/form-data">
                        <input type="hidden" id="tr52-call-number">
                        <div class="mb-3">
                            <label for="tr52-file" class="form-label">Select TR52 File</label>
                            <input type="file" class="form-control" id="tr52-file" accept=".pdf" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Send Notification Modal -->
    <div class="modal fade" id="sendNotificationModal" tabindex="-1" aria-labelledby="sendNotificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendNotificationModalLabel">Send Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="send-notification-form">
                        <input type="hidden" id="notification-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6>Notification Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <dl>
                                            <dt>Vehicle</dt>
                                            <dd id="notification-vehicle"></dd>
                                            <dt>Type</dt>
                                            <dd id="notification-type"></dd>
                                            <dt>Due Date</dt>
                                            <dd id="notification-due-date"></dd>
                                            <dt>Jurisdiction</dt>
                                            <dd id="notification-jurisdiction"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="notification-method-select" class="form-label">Send Via</label>
                                    <select class="form-control" id="notification-method-select">
                                        <option value="email">Email</option>
                                        <option value="fax">Fax</option>
                                        <option value="mail">Mail</option>
                                        <option value="manual">Mark As Sent Manually</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="notification-recipient" class="form-label">Recipient</label>
                                    <input type="text" class="form-control" id="notification-recipient">
                                </div>
                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Fees Modal -->
    <div class="modal fade" id="storageFeesModal" tabindex="-1" aria-labelledby="storageFeesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storageFeesModalLabel">Storage Fee Calculator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="storage-rate" class="form-label">Daily Storage Rate</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="storage-rate" value="25.00" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="storage-tow-date" class="form-label">Tow Date</label>
                        <input type="date" class="form-control" id="storage-tow-date" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="storage-days" class="form-label">Days in Storage</label>
                        <input type="number" class="form-control" id="storage-days" readonly>
                    </div>
                    <div class="alert alert-info">
                        <h4 class="alert-heading" id="storage-fee-total">$0.00</h4>
                        <p class="mb-0">Total storage fees as of today</p>
                    </div>
                    <input type="hidden" id="storage-call-number">
                    <button type="button" class="btn btn-primary" id="update-storage-btn">Update Vehicle Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TR208 Eligibility Assessment Modal -->
    <div class="modal fade" id="tr208EligibilityModal" tabindex="-1" aria-labelledby="tr208EligibilityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tr208EligibilityModalLabel">TR208 Eligibility Assessment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <p><strong>TR208 Eligibility Criteria:</strong> The vehicle must meet ALL of the following:</p>
                        <ol>
                            <li>Vehicle is 7+ years old</li>
                            <li>Vehicle is inoperable</li>
                            <li>Vehicle has extensive damage</li>
                        </ol>
                        <p>Vehicles meeting these criteria can be processed for scrap after 27 days (police notification + 20-day owner redemption period).</p>
                    </div>
                    
                    <div id="tr208-assessment-results" class="mb-4"></div>
                    
                    <form id="vehicle-condition-form">
                        <input type="hidden" id="tr208-call-number">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Vehicle Age:</label>
                                <div id="vehicle-age-display">Unknown</div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="vehicle-inoperable">
                                    <label class="form-check-label" for="vehicle-inoperable">Vehicle is inoperable</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="damage-extent" class="form-label">Damage Extent:</label>
                            <select class="form-control" id="damage-extent">
                                <option value="None">None/Minor Damage</option>
                                <option value="Moderate">Moderate Damage</option>
                                <option value="Extensive">Extensive Damage</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="condition-notes" class="form-label">Condition Notes:</label>
                            <textarea class="form-control" id="condition-notes" rows="3" placeholder="Describe the vehicle condition and damage..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Vehicle Condition</button>
                    </form>
                    
                    <div id="tr208-action-buttons" class="mt-4 d-none">
                        <hr>
                        <div class="d-grid gap-2">
                            <button id="generate-tr208-btn" class="btn btn-success">Generate TR208 Form</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TR208 Status Update Modal -->
    <div class="modal fade" id="tr208StatusModal" tabindex="-1" aria-labelledby="tr208StatusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tr208StatusModalLabel">TR208 Status Update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="tr208-status-form">
                        <input type="hidden" id="tr208-status-call-number">
                        <div class="mb-3">
                            <label class="form-label">Update Vehicle Status:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tr208Status" id="tr208-ready" value="TR208 Ready" checked>
                                <label class="form-check-label" for="tr208-ready">
                                    Mark as TR208 Ready
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tr208Status" id="ready-for-scrap" value="Ready for Scrap">
                                <label class="form-check-label" for="ready-for-scrap">
                                    Mark as Ready for Scrap
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <p>Marking as "TR208 Ready" indicates you've received the TR208 form from the police agency.</p>
                            <p>Marking as "Ready for Scrap" indicates the vehicle is ready for final disposition.</p>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Status</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-screen Photo Viewer -->
    <div id="fullscreen-photo-container" class="fullscreen-photo d-none">
        <div class="close-btn">&times;</div>
        <img id="fullscreen-photo" src="" alt="Vehicle Photo">
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let currentTab = 'active';
        let sortColumn = 'tow_date';
        let sortDirection = 'desc';
        let pendingNotificationsCount = 0;

        $(document).ready(function() {
            // Set today's date as default for date inputs
            const today = new Date().toISOString().split('T')[0];
            $('#tow_date').val(today);
            $('#communication_date').val(today);
            $('#release_date').val(today);
            
            loadVehicles(currentTab);
            loadWorkflowCounts();
            loadUpcomingActions();
            checkPendingNotifications();
            setupEventListeners();
            checkScrapingProgress();
            
            // Auto-refresh data every 5 minutes
            setInterval(function() {
                if (currentTab === 'active' || currentTab === 'New' || 
                    currentTab === 'TOP_Generated' || currentTab === 'TR52_Ready') {
                    loadVehicles(currentTab);
                }
                loadWorkflowCounts();
                loadUpcomingActions();
                checkPendingNotifications();
            }, 300000); // 5 minutes in milliseconds
        });

        function setupEventListeners() {
            // Sidebar navigation
            $('.sidebar a').click(function(e) {
                e.preventDefault();
                $('.sidebar a').removeClass('active');
                $(this).addClass('active');
                currentTab = $(this).data('tab');
                $('#page-title').text($(this).text().trim());
                
                // Hide all containers
                $('#vehicles-container, #notifications-container, #contacts-container, #statistics-container, #compliance-container').addClass('d-none');
                $('#workflow-counts').show();
                $('#upcoming-actions-dashboard').show();
                
                if (currentTab === 'notifications') {
                    $('#notifications-container').removeClass('d-none');
                    loadPendingNotifications();
                } else if (currentTab === 'contacts') {
                    $('#contacts-container').removeClass('d-none');
                    loadContacts();
                } else if (currentTab === 'statistics') {
                    $('#statistics-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    updateStatistics();
                } else if (currentTab === 'compliance') {
                    $('#compliance-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    loadComplianceStatus();
                    $('#compliance-notification-count').text(pendingNotificationsCount);
                } else {
                    $('#vehicles-container').removeClass('d-none');
                    loadVehicles(currentTab);
                }
            });

            // Table sorting
            $('.vehicle-table th').click(function() {
                const column = $(this).data('sort');
                if (column) {
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    $('.vehicle-table th').removeClass('sorted-asc sorted-desc');
                    $(this).addClass(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    loadVehicles(currentTab);
                }
            });

            // Add vehicle form
            $('#add-vehicle-form').submit(function(e) {
                e.preventDefault();
                const formData = {};
                $(this).serializeArray().forEach(item => {
                    formData[item.name] = item.value;
                });
                
                // Check if auto-generate TOP is checked
                const autoTop = $('#auto_top').is(':checked');
                
                $.ajax({
                    url: '/api/vehicles/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (autoTop && formData.vin && formData.vin !== 'N/A') {
                            // Auto-generate TOP form
                            const callNumber = formData.towbook_call_number || response.call_number;
                            $.ajax({
                                url: `/api/generate-top/${callNumber}`,
                                method: 'POST',
                                xhrFields: { responseType: 'blob' },
                                success: function() {
                                    alert('Vehicle added and TOP form generated successfully!');
                                    $('#addVehicleModal').modal('hide');
                                    $('#add-vehicle-form')[0].reset();
                                    loadVehicles(currentTab);
                                    loadUpcomingActions();
                                },
                                error: function() {
                                    alert('Vehicle added but TOP form generation failed.');
                                    $('#addVehicleModal').modal('hide');
                                    $('#add-vehicle-form')[0].reset();
                                    loadVehicles(currentTab);
                                    loadUpcomingActions();
                                }
                            });
                        } else {
                            alert(response.message);
                            $('#addVehicleModal').modal('hide');
                            $('#add-vehicle-form')[0].reset();
                            loadVehicles(currentTab);
                            loadUpcomingActions();
                        }
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseJSON.message);
                    }
                });
            });

            // Edit vehicle form
            $('#edit-vehicle-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#edit-call-number').val();
                const formData = {};
                $(this).serializeArray().forEach(item => {
                    formData[item.name] = item.value;
                });
                
                $.ajax({
                    url: `/api/vehicles/${callNumber}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert(response.message);
                        $('#editVehicleModal').modal('hide');
                        loadVehicles(currentTab);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseJSON.message);
                    }
                });
            });

            // Photo upload form
            $('#photo-upload-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#photo-call-number').val();
                const formData = new FormData();
                formData.append('file', $('#photo-file')[0].files[0]);
                
                $.ajax({
                    url: `/api/upload-photo/${callNumber}`,
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('Photo uploaded successfully');
                        loadVehicleDetails(callNumber);
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseJSON.error);
                    }
                });
            });

            // Document upload form
            $('#document-upload-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#document-call-number').val();
                const formData = new FormData();
                formData.append('file', $('#document-file')[0].files[0]);
                formData.append('type', $('#document-type').val());
                
                $.ajax({
                    url: `/api/upload-document/${callNumber}`,
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('Document uploaded successfully');
                        loadDocuments(callNumber);
                    },
                    error: function(xhr) {
                        alert('Error: ' + xhr.responseJSON.error);
                    }
                });
            });

            // Police log form
            $('#police-log-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#log-call-number').val();
                const logData = {
                    communication_date: $('#communication_date').val(),
                    communication_type: $('#communication_type').val(),
                    notes: $('#communication_notes').val(),
                    recipient: $('#communication_recipient').val(),
                    contact_method: $('#communication_method').val()
                };
                
                $.ajax({
                    url: `/api/police-logs/${callNumber}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(logData),
                    success: function(response) {
                        alert('Communication log added successfully');
                        loadPoliceLogs(callNumber);
                        $('#communication_notes').val('');
                        $('#communication_recipient').val('');
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // Release notice form
            $('#release-notice-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#release-call-number').val();
                const formData = {
                    release_reason: $('#release_reason').val(),
                    recipient: $('#recipient').val(),
                    release_date: $('#release_date').val(),
                    release_time: $('#release_time').val(),
                    sale_amount: $('#sale_amount').val(),
                    fees: $('#fees').val()
                };
                
                $.ajax({
                    url: `/api/generate-release/${callNumber}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    xhrFields: { responseType: 'blob' },
                    success: function(data) {
                        const url = window.URL.createObjectURL(data);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Release_${callNumber}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        // Check if notification should be sent
                        const method = $('#notification-method').val();
                        if (method !== 'none') {
                            // Create notification 
                            alert('Release notice generated successfully. Vehicle has been marked as released.');
                        } else {
                            alert('Release notice generated successfully. Vehicle has been marked as released.');
                        }
                        
                        $('#releaseNoticeModal').modal('hide');
                        loadVehicles(currentTab);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // Contact form
            $('#contact-form').submit(function(e) {
                e.preventDefault();
                const formData = {};
                $(this).serializeArray().forEach(item => {
                    formData[item.name] = item.value;
                });
                
                $.ajax({
                    url: '/api/contacts',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        alert(response.message);
                        $('#addContactModal').modal('hide');
                        $('#contact-form')[0].reset();
                        loadContacts();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Decision form
            $('#decision-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#decision-call-number').val();
                const decision = $('input[name="decision"]:checked').val();
                const data = { decision };
                
                if (decision === 'auction' && $('#auction-date').val()) {
                    data.auction_date = $('#auction-date').val();
                } else if (decision === 'scrap') {
                    data.salvage_value = $('#scrap-value').val();
                }
                
                $.ajax({
                    url: `/api/decision/${callNumber}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert('Decision recorded successfully');
                        $('#decisionModal').modal('hide');
                        loadVehicles(currentTab);
                        loadVehicleDetails(callNumber);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // TR52 upload form
            $('#upload-tr52-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#tr52-call-number').val();
                const formData = new FormData();
                formData.append('file', $('#tr52-file')[0].files[0]);
                
                $.ajax({
                    url: `/api/upload-tr52/${callNumber}`,
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('TR52 uploaded successfully');
                        $('#uploadTR52Modal').modal('hide');
                        loadVehicleDetails(callNumber);
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // Send notification form
            $('#send-notification-form').submit(function(e) {
                e.preventDefault();
                const notificationId = $('#notification-id').val();
                const method = $('#notification-method-select').val();
                const recipient = $('#notification-recipient').val();
                
                $.ajax({
                    url: `/api/notification/${notificationId}/send`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ method, recipient }),
                    success: function(response) {
                        if (response.document) {
                            alert('Notification sent successfully. Document generated.');
                            // Download document if available
                            const url = `/api/document-download/${response.document}`;
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = response.document;
                            a.click();
                        } else {
                            alert('Notification marked as sent successfully');
                        }
                        
                        $('#sendNotificationModal').modal('hide');
                        loadPendingNotifications();
                        checkPendingNotifications();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Update storage fees button
            $('#update-storage-btn').click(function() {
                const callNumber = $('#storage-call-number').val();
                const storageRate = $('#storage-rate').val();
                const storageDays = $('#storage-days').val();
                const storageFee = parseFloat(storageRate) * parseInt(storageDays);
                
                $.ajax({
                    url: `/api/vehicles/${callNumber}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        storage_fee_per_day: storageRate,
                        storage_days: storageDays,
                        storage_fees: storageFee.toFixed(2)
                    }),
                    success: function(response) {
                        alert('Storage fees updated successfully');
                        $('#storageFeesModal').modal('hide');
                        loadVehicleDetails(callNumber);
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            // Toggle auction/scrap fields in decision form
            $('input[name="decision"]').change(function() {
                if ($(this).val() === 'auction') {
                    $('#auction-date-field').show();
                    $('#scrap-value-field').hide();
                } else {
                    $('#auction-date-field').hide();
                    $('#scrap-value-field').show();
                }
            });

            // Toggle auction fields in release notice form
            $('#release_reason').change(function() {
                $('#auction-fields').toggle($(this).val() === 'Auctioned');
            });

            // Close fullscreen photo
            $('.close-btn').click(function() {
                $('#fullscreen-photo-container').addClass('d-none');
            });

            // Handle fullscreen photo escape key
            $(document).keyup(function(e) {
                if (e.key === "Escape" && !$('#fullscreen-photo-container').hasClass('d-none')) {
                    $('#fullscreen-photo-container').addClass('d-none');
                }
            });

            // Setup TR208 assessment form
            $('#vehicle-condition-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#tr208-call-number').val();
                const data = {
                    inoperable: $('#vehicle-inoperable').is(':checked') ? 1 : 0,
                    damage_extent: $('#damage-extent').val(),
                    condition_notes: $('#condition-notes').val()
                };
                
                $.ajax({
                    url: `/api/update-vehicle-condition/${callNumber}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert('Vehicle condition updated successfully');
                        checkTR208Eligibility(callNumber);
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // Generate TR208 form
            $(document).on('click', '#generate-tr208-btn', function() {
                const callNumber = $('#tr208-call-number').val();
                
                $.ajax({
                    url: `/api/generate-tr208/${callNumber}`,
                    method: 'POST',
                    xhrFields: { responseType: 'blob' },
                    success: function(data) {
                        const url = window.URL.createObjectURL(data);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `TR208_${callNumber}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        alert('TR208 form generated successfully.');
                        $('#tr208EligibilityModal').modal('hide');
                        loadVehicleDetails(callNumber);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        // Try to get error message from JSON response
                        const reader = new FileReader();
                        reader.onload = function() {
                            try {
                                const errorObj = JSON.parse(reader.result);
                                alert('Error: ' + (errorObj.error || 'Unknown error'));
                            } catch (e) {
                                alert('Error generating TR208 form.');
                            }
                        };
                        reader.readAsText(xhr.response);
                    }
                });
            });

            // TR208 status form submission
            $('#tr208-status-form').submit(function(e) {
                e.preventDefault();
                const callNumber = $('#tr208-status-call-number').val();
                const status = $('input[name="tr208Status"]:checked').val();
                
                $.ajax({
                    url: `/api/update-status/${callNumber}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ status: status }),
                    success: function(response) {
                        alert(`Vehicle status updated to ${status}`);
                        $('#tr208StatusModal').modal('hide');
                        loadVehicles(currentTab);
                        loadVehicleDetails(callNumber);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });

            // System action buttons
            $('#run-status-checks-btn').click(function() {
                runStatusChecks();
            });
            
            $('#fix-vehicle-statuses-btn').click(function() {
                fixVehicleStatuses();
            });
            
            // View pending notifications button
            $('#view-pending-notifications-btn').click(function() {
                $('.sidebar a[data-tab="notifications"]').click();
            });
        }

        // Fixed loadVehicles function to properly handle status types and parsing
     // Update this JavaScript function to properly handle status types and date parsing
        function loadVehicles(tab) {
            // Construct the correct URL based on tab - keep underscore format for frontend
            const url = tab === 'active' 
                ? `/api/vehicles?sort=${sortColumn}&direction=${sortDirection}` 
                : `/api/vehicles?status_type=${tab}&sort=${sortColumn}&direction=${sortDirection}`;
            
            console.log(`Loading vehicles with URL: ${url}`);
            
            $.get(url, function(data) {
                const tbody = $('#vehicle-table-body');
                tbody.empty();
                
                if (data.length === 0) {
                    tbody.html('<tr><td colspan="12" class="text-center">No vehicles found</td></tr>');
                    return;
                }
                
                data.forEach(vehicle => {
                    // Make sure all properties have values to prevent "undefined" errors
                    for (const key in vehicle) {
                        if (vehicle[key] === null || vehicle[key] === undefined) {
                            vehicle[key] = 'N/A';
                        }
                    }
                    
                    const statusClass = {
                        'New': 'status-new',
                        'TOP Generated': 'status-top',
                        'TR52 Ready': 'status-tr52',
                        'TR208 Ready': 'status-tr208',
                        'Ready for Auction': 'status-auction',
                        'Ready for Scrap': 'status-scrap',
                        'Released': 'status-released',
                        'Auctioned': 'status-released',
                        'Scrapped': 'status-released',
                        'Transferred': 'status-released'
                    }[vehicle.status] || '';
                    
                    // Create timeline indicator with safe handling of values
                    let timelineIndicator = '';
                    if (vehicle.days_until_next_step !== undefined && vehicle.days_until_next_step !== 'N/A') {
                        const daysValue = parseInt(vehicle.days_until_next_step) || 0;
                        const daysClass = daysValue <= 1 ? 'critical' : 
                                    daysValue <= 3 ? 'warning' : '';
                        timelineIndicator = `<span class="days-counter ${daysClass}">${daysValue} days</span>`;
                    } else if (vehicle.days_until_auction !== undefined && vehicle.days_until_auction !== 'N/A') {
                        const daysValue = parseInt(vehicle.days_until_auction) || 0;
                        const daysClass = daysValue <= 1 ? 'critical' : 
                                    daysValue <= 3 ? 'warning' : '';
                        timelineIndicator = `<span class="days-counter ${daysClass}">${daysValue} days</span>`;
                    } else if (vehicle.days_since_tow !== undefined) {
                        const daysValue = parseInt(vehicle.days_since_tow) || 0;
                        timelineIndicator = `<span class="days-counter">${daysValue} days</span>`;
                    }
                    
                    const row = `
                        <tr>
                            <td>${vehicle.towbook_call_number}</td>
                            <td>${vehicle.complaint_number || 'N/A'}</td>
                            <td>${vehicle.vin}</td>
                            <td>${vehicle.make}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.year}</td>
                            <td>${vehicle.color}</td>
                            <td>${vehicle.tow_date}</td>
                            <td>${vehicle.jurisdiction}</td>
                            <td><span class="status-label ${statusClass}">${vehicle.status}</span></td>
                            <td>${timelineIndicator}</td>
                            <td>
                                <button class="btn btn-sm btn-primary view-details" data-call-number="${vehicle.towbook_call_number}"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-secondary edit-vehicle" data-call-number="${vehicle.towbook_call_number}"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                    tbody.append(row);
                });
                
                // Add event listeners for the newly created buttons
                $('.view-details').click(function() {
                    const callNumber = $(this).data('call-number');
                    loadVehicleDetails(callNumber);
                });
                
                $('.edit-vehicle').click(function() {
                    const callNumber = $(this).data('call-number');
                    $.get(`/api/vehicles?call_number=${callNumber}`, function(data) {
                        if (data.length > 0) {
                            const vehicle = data[0];
                            $('#edit-call-number').val(vehicle.towbook_call_number);
                            $('#edit-complaint_number').val(vehicle.complaint_number !== 'N/A' ? vehicle.complaint_number : '');
                            $('#edit-vin').val(vehicle.vin !== 'N/A' ? vehicle.vin : '');
                            $('#edit-make').val(vehicle.make !== 'N/A' ? vehicle.make : '');
                            $('#edit-model').val(vehicle.model !== 'N/A' ? vehicle.model : '');
                            $('#edit-year').val(vehicle.year !== 'N/A' ? vehicle.year : '');
                            $('#edit-color').val(vehicle.color !== 'N/A' ? vehicle.color : '');
                            $('#edit-plate').val(vehicle.plate !== 'N/A' ? vehicle.plate : '');
                            $('#edit-state').val(vehicle.state !== 'N/A' ? vehicle.state : '');
                            $('#edit-tow_date').val(vehicle.tow_date !== 'N/A' ? vehicle.tow_date : '');
                            $('#edit-tow_time').val(vehicle.tow_time !== 'N/A' ? vehicle.tow_time : '');
                            
                            // Handle requested_by vs requestor field
                            const requestedBy = vehicle.requested_by !== 'N/A' ? vehicle.requested_by : 
                                                vehicle.requestor !== 'N/A' ? vehicle.requestor : '';
                            $('#edit-requested_by').val(requestedBy);
                            
                            $('#edit-location').val(vehicle.location !== 'N/A' ? vehicle.location : '');
                            $('#edit-jurisdiction').val(vehicle.jurisdiction !== 'N/A' ? vehicle.jurisdiction : '');
                            $('#edit-status').val(vehicle.status);
                            $('#edit-officer_name').val(vehicle.officer_name !== 'N/A' ? vehicle.officer_name : '');
                            $('#edit-case_number').val(vehicle.case_number !== 'N/A' ? vehicle.case_number : '');
                            $('#editVehicleModal').modal('show');
                        }
                    });
                });
            }).fail(function(xhr, status, error) {
                console.error("Error loading vehicles:", error);
                console.error("Response:", xhr.responseText);
                $('#vehicle-table-body').html('<tr><td colspan="12" class="text-center text-danger">Error loading vehicles. Please check console for details.</td></tr>');
            });
        }

        // Add this event listener to handle sidebar navigation
        $(document).ready(function() {
            // Sidebar navigation
            $('.sidebar a').click(function(e) {
                e.preventDefault();
                $('.sidebar a').removeClass('active');
                $(this).addClass('active');
                currentTab = $(this).data('tab');
                
                // Format the page title correctly
                if (currentTab === 'TOP_Generated') {
                    $('#page-title').text('TOP Generated');
                } else if (currentTab === 'TR52_Ready') {
                    $('#page-title').text('TR52 Ready');
                } else if (currentTab === 'TR208_Ready') {
                    $('#page-title').text('TR208 Ready');
                } else if (currentTab === 'Ready_for_Auction') {
                    $('#page-title').text('Ready for Auction');
                } else if (currentTab === 'Ready_for_Scrap') {
                    $('#page-title').text('Ready for Scrap');
                } else {
                    $('#page-title').text($(this).text().trim());
                }
                
                // Hide all containers
                $('#vehicles-container, #notifications-container, #contacts-container, #statistics-container, #compliance-container').addClass('d-none');
                $('#workflow-counts').show();
                $('#upcoming-actions-dashboard').show();
                
                if (currentTab === 'notifications') {
                    $('#notifications-container').removeClass('d-none');
                    loadPendingNotifications();
                } else if (currentTab === 'contacts') {
                    $('#contacts-container').removeClass('d-none');
                    loadContacts();
                } else if (currentTab === 'statistics') {
                    $('#statistics-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    updateStatistics();
                } else if (currentTab === 'compliance') {
                    $('#compliance-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    loadComplianceStatus();
                    $('#compliance-notification-count').text(pendingNotificationsCount);
                } else {
                    $('#vehicles-container').removeClass('d-none');
                    loadVehicles(currentTab);
                }
            });

            // Set the initial tab
            loadVehicles('active');
            
            // Debug helpers
            window.debugFilters = function(statusType) {
                console.log("Status type:", statusType);
                // You can add more debug functions as needed
            };
        });

        // This event listener fixes the sidebar navigation
        $(document).ready(function() {
            // Sidebar navigation
            $('.sidebar a').click(function(e) {
                e.preventDefault();
                $('.sidebar a').removeClass('active');
                $(this).addClass('active');
                currentTab = $(this).data('tab');
                
                // Fix for status types with different formats
                if (currentTab === 'TOP_Generated') {
                    $('#page-title').text('TOP Generated');
                } else if (currentTab === 'TR52_Ready') {
                    $('#page-title').text('TR52 Ready');
                } else if (currentTab === 'TR208_Ready') {
                    $('#page-title').text('TR208 Ready');
                } else if (currentTab === 'Ready_for_Auction') {
                    $('#page-title').text('Ready for Auction');
                } else if (currentTab === 'Ready_for_Scrap') {
                    $('#page-title').text('Ready for Scrap');
                } else {
                    $('#page-title').text($(this).text().trim());
                }
                
                // Hide all containers
                $('#vehicles-container, #notifications-container, #contacts-container, #statistics-container, #compliance-container').addClass('d-none');
                $('#workflow-counts').show();
                $('#upcoming-actions-dashboard').show();
                
                if (currentTab === 'notifications') {
                    $('#notifications-container').removeClass('d-none');
                    loadPendingNotifications();
                } else if (currentTab === 'contacts') {
                    $('#contacts-container').removeClass('d-none');
                    loadContacts();
                } else if (currentTab === 'statistics') {
                    $('#statistics-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    updateStatistics();
                } else if (currentTab === 'compliance') {
                    $('#compliance-container').removeClass('d-none');
                    $('#workflow-counts').hide();
                    $('#upcoming-actions-dashboard').hide();
                    loadComplianceStatus();
                    $('#compliance-notification-count').text(pendingNotificationsCount);
                } else {
                    $('#vehicles-container').removeClass('d-none');
                    loadVehicles(currentTab);
                }
            });
        });

        function loadVehicleDetails(callNumber) {
            $.get(`/api/vehicles?call_number=${callNumber}`, function(data) {
                if (data.length > 0) {
                    const vehicle = data[0];
                    
                    // Set vehicle ID in all forms
                    $('#photo-call-number').val(callNumber);
                    $('#log-call-number').val(callNumber);
                    $('#document-call-number').val(callNumber);
                    $('#release-call-number').val(callNumber);
                    $('#tr52-call-number').val(callNumber);
                    $('#decision-call-number').val(callNumber);
                    $('#storage-call-number').val(callNumber);
                    $('#tr208-call-number').val(callNumber);
                    $('#tr208-status-call-number').val(callNumber);
                    
                    // Set modal title
                    $('#vehicleDetailsModalLabel').text(`Vehicle Details: ${vehicle.make} ${vehicle.model} (${callNumber})`);
                    
                    // Fill vehicle info
                    $('#vehicle-info').text(JSON.stringify(vehicle, null, 2));
                    
                    // Fill vehicle info card
                    const vehicleInfoHTML = `
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Make/Model:</dt>
                            <dd class="col-sm-8">${vehicle.make} ${vehicle.model}</dd>
                            <dt class="col-sm-4">Year/Color:</dt>
                            <dd class="col-sm-8">${vehicle.year} ${vehicle.color}</dd>
                            <dt class="col-sm-4">VIN:</dt>
                            <dd class="col-sm-8">${vehicle.vin}</dd>
                            <dt class="col-sm-4">Plate:</dt>
                            <dd class="col-sm-8">${vehicle.plate} (${vehicle.state})</dd>
                            <dt class="col-sm-4">Tow Date:</dt>
                            <dd class="col-sm-8">${vehicle.tow_date} ${vehicle.tow_time}</dd>
                            <dt class="col-sm-4">Location:</dt>
                            <dd class="col-sm-8">${vehicle.location}</dd>
                            <dt class="col-sm-4">Jurisdiction:</dt>
                            <dd class="col-sm-8">${vehicle.jurisdiction}</dd>
                            <dt class="col-sm-4">Requested By:</dt>
                            <dd class="col-sm-8">${vehicle.requested_by || 'N/A'}</dd>
                        </dl>
                    `;
                    $('#vehicle-info-card').html(vehicleInfoHTML);
                    
                    // Fill status info card
                    const statusInfoHTML = `
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8"><span class="badge bg-primary">${vehicle.status}</span></dd>
                            <dt class="col-sm-4">Complaint #:</dt>
                            <dd class="col-sm-8">${vehicle.complaint_number}</dd>
                            <dt class="col-sm-4">Days Since Tow:</dt>
                            <dd class="col-sm-8">${vehicle.days_since_tow || 0} days</dd>
                            <dt class="col-sm-4">TOP Sent:</dt>
                            <dd class="col-sm-8">${vehicle.top_form_sent_date || 'Not sent'}</dd>
                            <dt class="col-sm-4">TR52/TR208 Available:</dt>
                            <dd class="col-sm-8">${vehicle.tr52_available_date || vehicle.tr208_available_date || 'N/A'}</dd>
                            <dt class="col-sm-4">Decision:</dt>
                            <dd class="col-sm-8">${vehicle.decision || 'Pending'}</dd>
                            <dt class="col-sm-4">Auction Date:</dt>
                            <dd class="col-sm-8">${vehicle.auction_date || 'N/A'}</dd>
                            <dt class="col-sm-4">Storage Fees:</dt>
                            <dd class="col-sm-8">$${(vehicle.storage_fee || '0.00')}</dd>
                        </dl>
                    `;
                    $('#status-info-card').html(statusInfoHTML);
                    
                    // Load related data
                    loadTimeline(callNumber);
                    loadPhotos(callNumber);
                    loadPoliceLogs(callNumber);
                    loadDocuments(callNumber);
                    
                    // Create visual timeline
                    createVisualTimeline(vehicle);
                    
                    // Set up action buttons
                    setupActionButtons(vehicle);
                    
                    // Show the modal
                    $('#vehicleDetailsModal').modal('show');
                }
            });
        }

        function setupActionButtons(vehicle) {
            // TOP Form Generation
            $('#generate-top-btn').off('click').click(function() {
                $.ajax({
                    url: `/api/generate-top/${vehicle.towbook_call_number}`,
                    method: 'POST',
                    xhrFields: { responseType: 'blob' },
                    success: function(data) {
                        const url = window.URL.createObjectURL(data);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `TOP_${vehicle.towbook_call_number}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        alert('TOP form generated successfully. Vehicle status updated to TOP Generated.');
                        loadVehicles(currentTab);
                        loadVehicleDetails(vehicle.towbook_call_number);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            
            // TR52 Form Generation
            $('#generate-tr52-btn').off('click').click(function() {
                $.ajax({
                    url: `/api/generate-tr52/${vehicle.towbook_call_number}`,
                    method: 'POST',
                    xhrFields: { responseType: 'blob' },
                    success: function(data) {
                        const url = window.URL.createObjectURL(data);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `TR52_${vehicle.towbook_call_number}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        alert('TR52 form generated successfully.');
                        loadVehicleDetails(vehicle.towbook_call_number);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            
            // Check TR208 Eligibility
            $('#check-tr208-btn').off('click').click(function() {
                setupTR208Assessment(vehicle);
                $('#tr208EligibilityModal').modal('show');
            });
            
            // Release Notice Generation
            $('#generate-release-btn').off('click').click(function() {
                $('#release_date').val(new Date().toISOString().split('T')[0]);
                $('#release_time').val(new Date().toTimeString().split(' ')[0].substr(0, 5));
                $('#release_reason').val('Owner Redeemed');
                $('#recipient').val('');
                $('#sale_amount').val('');
                $('#fees').val('');
                $('#auction-fields').hide();
                $('#releaseNoticeModal').modal('show');
            });
            
            // Upload TR52
            $('#upload-tr52-btn').off('click').click(function() {
                $('#uploadTR52Modal').modal('show');
            });
            
            // Mark TR52 Ready
            $('#mark-tr52-ready-btn').off('click').click(function() {
                $.ajax({
                    url: `/api/mark-tr52-ready/${vehicle.towbook_call_number}`,
                    method: 'POST',
                    success: function(response) {
                        alert('Vehicle marked as TR52 Ready');
                        loadVehicles(currentTab);
                        loadVehicleDetails(vehicle.towbook_call_number);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            
            // Make Decision (Auction/Scrap)
            $('#make-decision-btn').off('click').click(function() {
                $('#decision-auction').prop('checked', true);
                $('#auction-date-field').show();
                $('#scrap-value-field').hide();
                
                // Set default auction date to next Monday
                const today = new Date();
                const nextMonday = new Date();
                nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));
                $('#auction-date').val(nextMonday.toISOString().split('T')[0]);
                
                $('#scrap-value').val('0.00');
                $('#decisionModal').modal('show');
            });
            
            // Calculate Storage Fees
            $('#calculate-fees-btn').off('click').click(function() {
                const towDate = vehicle.tow_date;
                const storageRate = 25.00; // Default daily rate
                
                $.ajax({
                    url: `/api/calculate-storage-fees/${vehicle.towbook_call_number}?rate=${storageRate}`,
                    method: 'GET',
                    success: function(response) {
                        $('#storage-tow-date').val(response.tow_date);
                        $('#storage-days').val(response.days);
                        $('#storage-rate').val(storageRate);
                        $('#storage-fee-total').text(response.formatted_fee);
                        $('#storageFeesModal').modal('show');
                    },
                    error: function(xhr) {
                        alert('Error calculating fees: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            
            // Generate Certified Mail Number
            $('#certified-mail-btn').off('click').click(function() {
                $.ajax({
                    url: `/api/generate-certified-mail/${vehicle.towbook_call_number}`,
                    method: 'POST',
                    success: function(response) {
                        alert(`Certified mail number generated: ${response.certified_mail_number}`);
                        loadVehicleDetails(vehicle.towbook_call_number);
                    },
                    error: function(xhr) {
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            });
            
            // Delete Vehicle
            $('#delete-vehicle-btn').off('click').click(function() {
                if (confirm(`Are you sure you want to permanently delete vehicle ${vehicle.towbook_call_number}?\n\nThis action cannot be undone!`)) {
                    $.ajax({
                        url: `/api/vehicles/delete/${vehicle.towbook_call_number}`,
                        method: 'DELETE',
                        success: function(response) {
                            alert(response.message);
                            $('#vehicleDetailsModal').modal('hide');
                            loadVehicles(currentTab);
                        },
                        error: function(xhr) {
                            alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                        }
                    });
                }
            });
        }

        function loadTimeline(callNumber) {
            $.get(`/api/logs?vehicle_id=${callNumber}`, function(logs) {
                const timeline = $('#vehicle-timeline');
                timeline.empty();
                
                if (logs.length === 0) {
                    timeline.html('<p class="text-muted">No timeline entries found</p>');
                    return;
                }
                
                logs.forEach(log => {
                    const badgeClass = {
                        'INSERT': 'bg-success',
                        'UPDATE': 'bg-info',
                        'STATUS_CHANGE': 'bg-primary',
                        'GENERATE_TOP': 'bg-warning text-dark',
                        'TR52_READY': 'bg-warning text-dark',
                        'TR208_READY': 'bg-warning text-dark',
                        'RELEASE': 'bg-secondary',
                        'PHOTO_UPLOAD': 'bg-info',
                        'DOCUMENT_UPLOAD': 'bg-info',
                        'NOTIFICATION': 'bg-light text-dark',
                        'CERTIFIED_MAIL': 'bg-light text-dark',
                        'AUTO_STATUS': 'bg-dark',
                        'UPDATE_CONDITION': 'bg-info'
                    }[log.action_type] || 'bg-secondary';
                    
                    const timelineItem = `
                        <div class="timeline-item">
                            <span class="badge ${badgeClass}">${log.action_type}</span>
                            <p class="mb-0">${log.details}</p>
                            <small class="text-muted">${log.timestamp}</small>
                        </div>
                    `;
                    timeline.append(timelineItem);
                });
            });
        }

        function loadPhotos(callNumber) {
            $.get(`/api/vehicles?call_number=${callNumber}`, function(data) {
                if (data.length > 0 && data[0].photo_paths && data[0].photo_paths !== 'N/A') {
                    let photos = [];
                    try {
                        photos = JSON.parse(data[0].photo_paths);
                    } catch (e) {
                        console.error('Error parsing photo paths:', e);
                    }
                    
                    const preview = $('#photo-preview');
                    preview.empty();
                    
                    if (photos.length === 0) {
                        preview.html('<p class="text-muted">No photos uploaded yet</p>');
                        return;
                    }
                    
                    photos.forEach(photo => {
                        preview.append(`
                            <img src="/static/uploads/vehicle_photos/${photo}" alt="Vehicle Photo" class="photo-thumbnail" data-src="/static/uploads/vehicle_photos/${photo}">
                        `);
                    });
                    
                    // Add click event for fullscreen viewing
                    $('.photo-thumbnail').click(function() {
                        const imgSrc = $(this).data('src');
                        $('#fullscreen-photo').attr('src', imgSrc);
                        $('#fullscreen-photo-container').removeClass('d-none');
                    });
                } else {
                    $('#photo-preview').html('<p class="text-muted">No photos uploaded yet</p>');
                }
            });
        }

        function loadPoliceLogs(callNumber) {
            $.get(`/api/police-logs/${callNumber}`, function(logs) {
                const tbody = $('#police-logs');
                tbody.empty();
                
                if (logs.length === 0) {
                    tbody.html('<tr><td colspan="5" class="text-center">No communication logs found</td></tr>');
                    return;
                }
                
                logs.forEach(log => {
                    tbody.append(`
                        <tr>
                            <td>${log.communication_date}</td>
                            <td>${log.communication_type}</td>
                            <td>${log.notes}</td>
                            <td>${log.recipient || 'N/A'}</td>
                            <td>${log.contact_method || 'N/A'}</td>
                        </tr>
                    `);
                });
            });
        }

        function loadDocuments(callNumber) {
            $.get(`/api/documents/${callNumber}`, function(documents) {
                const list = $('#document-list');
                list.empty();
                
                if (documents.length === 0) {
                    list.html('<p class="text-muted">No documents uploaded yet</p>');
                    return;
                }
                
                documents.forEach(doc => {
                    const iconClass = {
                        'TOP Form': 'fas fa-file-alt',
                        'TR52': 'fas fa-file-contract',
                        'TR52 Form': 'fas fa-file-contract',
                        'TR208': 'fas fa-file-contract',
                        'TR208 Form': 'fas fa-file-contract',
                        'Release Notice': 'fas fa-file-invoice',
                        'Title': 'fas fa-file-certificate',
                        'Police Report': 'fas fa-file-shield',
                        'Auction Receipt': 'fas fa-receipt',
                        'Scrap Receipt': 'fas fa-recycle',
                        'Certified Mail': 'fas fa-envelope',
                        'Other': 'fas fa-file'
                    }[doc.type] || 'fas fa-file';
                    
                    list.append(`
                        <div class="document-item">
                            <i class="${iconClass} text-primary"></i>
                            <div>
                                <a href="/api/document-download/${doc.filename}" target="_blank">${doc.type}</a>
                                <span class="document-date">${doc.upload_date}</span>
                            </div>
                        </div>
                    `);
                });
            });
        }

        function loadWorkflowCounts() {
            $.get('/api/workflow-counts', function(data) {
                $('#overdue-count').text(data.overdue);
                $('#due-today-count').text(data.dueToday);
                $('#ready-count').text(data.ready);
                $('#notifications-count').text(data.pendingNotifications);
                
                // Update notification badge
                if (data.pendingNotifications > 0) {
                    $('#notification-count').text(data.pendingNotifications).removeClass('d-none');
                    pendingNotificationsCount = data.pendingNotifications;
                } else {
                    $('#notification-count').addClass('d-none');
                    pendingNotificationsCount = 0;
                }
            });
        }

        function checkPendingNotifications() {
            $.get('/api/pending-notifications', function(notifications) {
                if (notifications.length > 0) {
                    pendingNotificationsCount = notifications.length;
                    $('#notification-count').text(pendingNotificationsCount).removeClass('d-none');
                } else {
                    pendingNotificationsCount = 0;
                    $('#notification-count').addClass('d-none');
                }
            });
        }

        function loadPendingNotifications() {
            $.get('/api/pending-notifications', function(notifications) {
                const container = $('#pending-notifications-list');
                container.empty();
                
                if (notifications.length === 0) {
                    container.html('<div class="alert alert-success">No pending notifications! You\'re all caught up.</div>');
                    return;
                }
                
                notifications.forEach(notification => {
                    const isUrgent = new Date(notification.due_date) <= new Date();
                    const urgentClass = isUrgent ? 'urgent' : '';
                    const vehicleDesc = [
                        notification.year,
                        notification.color,
                        notification.make,
                        notification.model
                    ].filter(Boolean).join(' ');
                    
                    const notificationItem = `
                        <div class="notification-item ${urgentClass}">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5>${notification.notification_type} - ${notification.vehicle_id}</h5>
                                    <p>${vehicleDesc} - VIN: ${notification.vin}</p>
                                    <p><strong>Jurisdiction:</strong> ${notification.jurisdiction}</p>
                                    <p><strong>Due Date:</strong> ${notification.due_date}</p>
                                </div>
                                <div class="col-md-4 d-flex align-items-center justify-content-end">
                                    <button class="btn btn-primary send-notification-btn" 
                                            data-notification-id="${notification.id}"
                                            data-vehicle-id="${notification.vehicle_id}"
                                            data-type="${notification.notification_type}"
                                            data-jurisdiction="${notification.jurisdiction}"
                                            data-due-date="${notification.due_date}">
                                        Send Notification
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.append(notificationItem);
                });
                
                // Add click handler for send notification buttons
                $('.send-notification-btn').click(function() {
                    const notificationId = $(this).data('notification-id');
                    const vehicleId = $(this).data('vehicle-id');
                    const notificationType = $(this).data('type');
                    const jurisdiction = $(this).data('jurisdiction');
                    const dueDate = $(this).data('due-date');
                    
                    // Populate the notification modal
                    $('#notification-id').val(notificationId);
                    $('#notification-vehicle').text(vehicleId);
                    $('#notification-type').text(notificationType);
                    $('#notification-due-date').text(dueDate);
                    $('#notification-jurisdiction').text(jurisdiction);
                    
                    // Get jurisdiction contact info
                    $.get('/api/contacts', function(contacts) {
                        const contact = contacts.find(c => c.jurisdiction === jurisdiction);
                        if (contact) {
                            $('#notification-recipient').val(contact.email || contact.fax || contact.phone);
                            $('#notification-method-select').val(contact.preferred_method);
                        } else {
                            $('#notification-recipient').val('');
                            $('#notification-method-select').val('email');
                        }
                        
                        // Show the modal
                        $('#sendNotificationModal').modal('show');
                    });
                });
            });
        }

        function loadContacts() {
            $.get('/api/contacts', function(contacts) {
                const container = $('#contacts-list');
                container.empty();
                
                if (contacts.length === 0) {
                    container.html('<div class="alert alert-info">No jurisdiction contacts added yet. Add contacts to streamline communication.</div>');
                    return;
                }
                
                contacts.forEach(contact => {
                    const contactCard = `
                        <div class="col-md-6 mb-3">
                            <div class="contact-card">
                                <h5>${contact.jurisdiction}</h5>
                                <p><strong>Contact:</strong> ${contact.contact_name}</p>
                                <p><strong>Email:</strong> ${contact.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${contact.phone || 'N/A'}</p>
                                <p><strong>Fax:</strong> ${contact.fax || 'N/A'}</p>
                                <p><strong>Preferred Method:</strong> ${contact.preferred_method}</p>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-secondary edit-contact-btn" data-contact-id="${contact.id}">Edit</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.append(contactCard);
                });
                
                // Add click handler for edit buttons
                $('.edit-contact-btn').click(function() {
                    const contactId = $(this).data('contact-id');
                    const contact = contacts.find(c => c.id === contactId);
                    
                    if (contact) {
                        $('#contact-id').val(contact.id);
                        $('#contact-jurisdiction').val(contact.jurisdiction);
                        $('#contact-name').val(contact.contact_name);
                        $('#contact-phone').val(contact.phone);
                        $('#contact-email').val(contact.email);
                        $('#contact-fax').val(contact.fax);
                        $('#contact-address').val(contact.address);
                        $('#contact-method').val(contact.preferred_method);
                        $('#contact-notes').val(contact.notes);
                        
                        $('#addContactModal').modal('show');
                    }
                });
            });
        }

        function updateStatistics() {
            $.get('/api/statistics', function(data) {
                const container = $('#statistics-container');
                container.empty();
                
                // Create stats dashboard
                const statsDashboard = `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>Total Vehicles</h3>
                                <div class="stat-value">${data.totalVehicles}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>Active Vehicles</h3>
                                <div class="stat-value">${data.statusCounts['New'] + 
                                                          (data.statusCounts['TOP Generated'] || 0) + 
                                                          (data.statusCounts['TR52 Ready'] || 0) + 
                                                          (data.statusCounts['TR208 Ready'] || 0) + 
                                                          (data.statusCounts['Ready for Auction'] || 0) + 
                                                          (data.statusCounts['Ready for Scrap'] || 0)}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>Completed</h3>
                                <div class="stat-value">${(data.statusCounts['Released'] || 0) + 
                                                          (data.statusCounts['Auctioned'] || 0) + 
                                                          (data.statusCounts['Scrapped'] || 0) +
                                                          (data.statusCounts['Transferred'] || 0)}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3>Avg. Processing</h3>
                                <div class="stat-value">${data.avgProcessingDays} days</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Status Breakdown</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group">
                                        ${Object.entries(data.statusCounts)
                                            .map(([status, count]) => `
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    ${status}
                                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                                </li>
                                            `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Top Jurisdictions</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group">
                                        ${Object.entries(data.jurisdictionCounts)
                                            .map(([jurisdiction, count]) => `
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    ${jurisdiction}
                                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                                </li>
                                            `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Compliance Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            TOP Notifications Sent
                                            <span class="badge bg-success rounded-pill">${data.complianceMetrics.topNotifications}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            TR52/TR208 Ready Notices
                                            <span class="badge bg-success rounded-pill">${data.complianceMetrics.tr52Ready}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Auction Ads Placed
                                            <span class="badge bg-success rounded-pill">${data.complianceMetrics.auctionAds}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Release Notifications
                                            <span class="badge bg-success rounded-pill">${data.complianceMetrics.releaseNotifications}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Total Sales
                                            <span class="badge bg-success rounded-pill">$${data.complianceMetrics.totalSales.toFixed(2)}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            Total Proceeds
                                            <span class="badge bg-success rounded-pill">$${data.complianceMetrics.totalProceeds.toFixed(2)}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Recent Activity</h5>
                                </div>
                                <div class="card-body">
                                    <div class="timeline">
                                        ${data.recentActivity.map(activity => `
                                            <div class="timeline-item">
                                                <span class="badge bg-primary">${activity.action_type}</span>
                                                <p class="mb-0">${activity.vehicle_id}: ${activity.details}</p>
                                                <small class="text-muted">${activity.timestamp}</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.html(statsDashboard);
            });
        }

        function loadComplianceStatus() {
            $.get('/api/statistics', function(data) {
                const statusContainer = $('#compliance-status');
                statusContainer.empty();
                
                // Compliance metrics from statistics
                const metrics = data.complianceMetrics;
                const totalVehicles = data.totalVehicles;
                const statusCounts = data.statusCounts;
                
                // Calculate percentages
                const activeVehicles = totalVehicles - (statusCounts['Released'] || 0) - (statusCounts['Auctioned'] || 0) - (statusCounts['Scrapped'] || 0) - (statusCounts['Transferred'] || 0);
                const topPercentage = activeVehicles > 0 ? Math.round((metrics.topNotifications / activeVehicles) * 100) : 0;
                const tr52Percentage = activeVehicles > 0 ? Math.round((metrics.tr52Ready / activeVehicles) * 100) : 0;
                const auctionAdsPercentage = activeVehicles > 0 ? Math.round((metrics.auctionAds / activeVehicles) * 100) : 0;
                const releaseNotificationsPercentage = totalVehicles > 0 ? Math.round((metrics.releaseNotifications / totalVehicles) * 100) : 0;
                
                // Determine compliance status
                const isFullyCompliant = topPercentage >= 95 && tr52Percentage >= 90 && auctionAdsPercentage >= 90 && releaseNotificationsPercentage >= 95;
                const isPartiallyCompliant = topPercentage >= 80 && tr52Percentage >= 70 && auctionAdsPercentage >= 70 && releaseNotificationsPercentage >= 80;
                
                let statusClass = 'alert-danger';
                let statusMessage = 'Non-Compliant';
                
                if (isFullyCompliant) {
                    statusClass = 'alert-success';
                    statusMessage = 'Fully Compliant';
                } else if (isPartiallyCompliant) {
                    statusClass = 'alert-warning';
                    statusMessage = 'Partially Compliant';
                }
                
                // Create status alert
                statusContainer.html(`
                    <div class="alert ${statusClass}">
                        <h4 class="alert-heading">System Compliance Status: ${statusMessage}</h4>
                        <p>Current compliance metrics based on vehicle processing status.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h5>TOP Forms</h5>
                                    <div class="display-4">${topPercentage}%</div>
                                    <p class="mb-0">${metrics.topNotifications} / ${activeVehicles} vehicles</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h5>TR52/TR208 Forms</h5>
                                    <div class="display-4">${tr52Percentage}%</div>
                                    <p class="mb-0">${metrics.tr52Ready} / ${activeVehicles} eligible vehicles</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h5>Auction Notices</h5>
                                    <div class="display-4">${auctionAdsPercentage}%</div>
                                    <p class="mb-0">${metrics.auctionAds} / ${activeVehicles} eligible vehicles</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card mb-3">
                                <div class="card-body text-center">
                                    <h5>Release Notifications</h5>
                                    <div class="display-4">${releaseNotificationsPercentage}%</div>
                                    <p class="mb-0">${metrics.releaseNotifications} / ${totalVehicles} total vehicles</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            });
        }

        function loadUpcomingActions() {
            $.get('/api/vehicles', function(vehicles) {
                const actionsTable = $('#upcoming-actions-table');
                actionsTable.empty();
                
                if (vehicles.length === 0) {
                    actionsTable.html('<tr><td colspan="6" class="text-center">No vehicles found</td></tr>');
                    return;
                }
                
                // Filter for active vehicles with upcoming actions
                const actionVehicles = vehicles.filter(v => 
                    !v.archived && 
                    (v.status === 'New' || 
                     v.status === 'TOP Generated' || 
                     v.status === 'TR52 Ready' || 
                     v.status === 'TR208 Ready' || 
                     v.status === 'Ready for Auction' || 
                     v.status === 'Ready for Scrap')
                );
                
                if (actionVehicles.length === 0) {
                    actionsTable.html('<tr><td colspan="6" class="text-center">No upcoming actions</td></tr>');
                    return;
                }
                
                // Sort by urgency (days until next step)
                actionVehicles.sort((a, b) => {
                    const aDays = a.days_until_next_step || a.days_until_auction || 999;
                    const bDays = b.days_until_next_step || b.days_until_auction || 999;
                    return aDays - bDays;
                });
                
                // Only show top 5 most urgent actions
                const topActions = actionVehicles.slice(0, 5);
                
                topActions.forEach(vehicle => {
                    let nextAction = '';
                    let dueDate = '';
                    let daysLeft = 0;
                    let actionButton = '';
                    
                    if (vehicle.status === 'New') {
                        nextAction = 'Generate TOP Form';
                        dueDate = vehicle.tow_date; // Should be within 24 hours of tow
                        
                        // Calculate days left (negative means overdue)
                        const towDate = new Date(vehicle.tow_date);
                        const today = new Date();
                        const diffTime = Math.abs(today - towDate);
                        daysLeft = 1 - Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        actionButton = `<button class="btn btn-sm btn-primary action-btn" data-action="generate-top" data-call-number="${vehicle.towbook_call_number}">Generate TOP</button>`;
                    }
                    else if (vehicle.status === 'TOP Generated') {
                        nextAction = 'Generate TR52/TR208';
                        dueDate = vehicle.tr52_available_date || vehicle.tr208_available_date;
                        daysLeft = vehicle.days_until_next_step;
                        
                        if (vehicle.tr208_eligible == 1) {
                            actionButton = `<button class="btn btn-sm btn-primary action-btn" data-action="check-tr208" data-call-number="${vehicle.towbook_call_number}">Check TR208</button>`;
                        } else {
                            actionButton = `<button class="btn btn-sm btn-primary action-btn" data-action="generate-tr52" data-call-number="${vehicle.towbook_call_number}">Generate TR52</button>`;
                        }
                    }
                    else if (vehicle.status === 'TR52 Ready' || vehicle.status === 'TR208 Ready') {
                        nextAction = 'Make Decision (Auction/Scrap)';
                        dueDate = 'Now';
                        daysLeft = 0;
                        
                        actionButton = `<button class="btn btn-sm btn-success action-btn" data-action="make-decision" data-call-number="${vehicle.towbook_call_number}">Make Decision</button>`;
                    }
                    else if (vehicle.status === 'Ready for Auction') {
                        nextAction = 'Schedule Auction';
                        dueDate = vehicle.auction_date;
                        daysLeft = vehicle.days_until_auction;
                        
                        actionButton = `<button class="btn btn-sm btn-warning action-btn" data-action="schedule-auction" data-call-number="${vehicle.towbook_call_number}">Schedule Auction</button>`;
                    }
                    else if (vehicle.status === 'Ready for Scrap') {
                        nextAction = 'Process for Scrap';
                        dueDate = vehicle.estimated_date;
                        daysLeft = vehicle.days_until_next_step;
                        
                        actionButton = `<button class="btn btn-sm btn-danger action-btn" data-action="process-scrap" data-call-number="${vehicle.towbook_call_number}">Process Scrap</button>`;
                    }
                    
                    // Determine urgency class
                    let urgencyClass = '';
                    if (daysLeft < 0) {
                        urgencyClass = 'table-danger';
                    } else if (daysLeft <= 2) {
                        urgencyClass = 'table-warning';
                    }
                    
                    const row = `
                        <tr class="${urgencyClass}">
                            <td>${vehicle.year} ${vehicle.make} ${vehicle.model} (${vehicle.towbook_call_number})</td>
                            <td><span class="badge ${getStatusBadgeClass(vehicle.status)}">${vehicle.status}</span></td>
                            <td>${nextAction}</td>
                            <td>${dueDate || 'N/A'}</td>
                            <td>${daysLeft < 0 ? `<span class="text-danger">${daysLeft} (OVERDUE)</span>` : daysLeft}</td>
                            <td>${actionButton}</td>
                        </tr>
                    `;
                    
                    actionsTable.append(row);
                });
                
                // Add event handlers for action buttons
                $('.action-btn').click(function() {
                    const action = $(this).data('action');
                    const callNumber = $(this).data('call-number');
                    
                    switch(action) {
                        case 'generate-top':
                            generateTOPForm(callNumber);
                            break;
                        case 'check-tr208':
                            openTR208Assessment(callNumber);
                            break;
                        case 'generate-tr52':
                            generateTR52Form(callNumber);
                            break;
                        case 'make-decision':
                            openDecisionModal(callNumber);
                            break;
                        case 'schedule-auction':
                            openAuctionModal(callNumber);
                            break;
                        case 'process-scrap':
                            openScrapModal(callNumber);
                            break;
                    }
                });
            });
        }

        // Helper function to get status badge class
        function getStatusBadgeClass(status) {
            const classes = {
                'New': 'bg-primary',
                'TOP Generated': 'bg-info',
                'TR52 Ready': 'bg-success',
                'TR208 Ready': 'bg-success',
                'Ready for Auction': 'bg-warning text-dark',
                'Ready for Scrap': 'bg-danger',
                'Released': 'bg-secondary',
                'Auctioned': 'bg-secondary',
                'Scrapped': 'bg-secondary',
                'Transferred': 'bg-secondary'
            };
            
            return classes[status] || 'bg-secondary';
        }

        // Open TR208 assessment modal
        function openTR208Assessment(callNumber) {
            $.get(`/api/vehicles?call_number=${callNumber}`, function(data) {
                if (data.length > 0) {
                    setupTR208Assessment(data[0]);
                    $('#tr208EligibilityModal').modal('show');
                }
            });
        }

        // Setup TR208 assessment
        function setupTR208Assessment(vehicle) {
            $('#tr208-call-number').val(vehicle.towbook_call_number);
            
            // Calculate vehicle age
            const currentYear = new Date().getFullYear();
            let vehicleYear = parseInt(vehicle.year);
            if (!isNaN(vehicleYear)) {
                const age = currentYear - vehicleYear;
                $('#vehicle-age-display').text(`${age} years old (${vehicle.year})`);
            } else {
                $('#vehicle-age-display').text('Unknown year');
            }
            
            // Set current values
            $('#vehicle-inoperable').prop('checked', vehicle.inoperable == 1);
            $('#damage-extent').val(vehicle.damage_extent || 'None');
            $('#condition-notes').val(vehicle.condition_notes || '');
            
            // Check current TR208 eligibility
            checkTR208Eligibility(vehicle.towbook_call_number);
        }

        // Check TR208 eligibility
        function checkTR208Eligibility(callNumber) {
            $.ajax({
                url: `/api/check-tr208-eligibility/${callNumber}`,
                method: 'GET',
                success: function(response) {
                    const resultsContainer = $('#tr208-assessment-results');
                    
                    if (response.eligible) {
                        resultsContainer.html(`
                            <div class="alert alert-success">
                                <h5><i class="fas fa-check-circle"></i> Vehicle is eligible for TR208 processing</h5>
                                <p>This vehicle meets all criteria for scrap vehicle processing:</p>
                                <ul>
                                    <li>Age: ${response.reasons.age}</li>
                                    <li>Operability: ${response.reasons.operable}</li>
                                    <li>Damage: ${response.reasons.damage}</li>
                                </ul>
                                ${response.timeline_date ? 
                                    `<p><strong>Available for TR208 processing on:</strong> ${response.timeline_date}</p>` : 
                                    ''}
                            </div>
                        `);
                        $('#tr208-action-buttons').removeClass('d-none');
                    } else {
                        resultsContainer.html(`
                            <div class="alert alert-warning">
                                <h5><i class="fas fa-exclamation-triangle"></i> Vehicle is NOT eligible for TR208 processing</h5>
                                <p>This vehicle does not meet all criteria for scrap vehicle processing:</p>
                                <ul>
                                    <li>Age: ${response.reasons.age}</li>
                                    <li>Operability: ${response.reasons.operable}</li>
                                    <li>Damage: ${response.reasons.damage}</li>
                                </ul>
                                <p>Please update the vehicle condition if necessary.</p>
                            </div>
                        `);
                        $('#tr208-action-buttons').addClass('d-none');
                    }
                },
                error: function(xhr) {
                    $('#tr208-assessment-results').html(`
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-times-circle"></i> Error checking eligibility</h5>
                            <p>${xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'}</p>
                        </div>
                    `);
                    $('#tr208-action-buttons').addClass('d-none');
                }
            });
        }

        // Generate TOP Form
        function generateTOPForm(callNumber) {
            $.ajax({
                url: `/api/generate-top/${callNumber}`,
                method: 'POST',
                xhrFields: { responseType: 'blob' },
                success: function(data) {
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TOP_${callNumber}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('TOP form generated successfully. Vehicle status updated to TOP Generated.');
                    loadVehicles(currentTab);
                    loadUpcomingActions();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        }

        // Generate TR52 Form
        function generateTR52Form(callNumber) {
            $.ajax({
                url: `/api/generate-tr52/${callNumber}`,
                method: 'POST',
                xhrFields: { responseType: 'blob' },
                success: function(data) {
                    const url = window.URL.createObjectURL(data);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TR52_${callNumber}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    alert('TR52 form generated successfully.');
                    loadVehicles(currentTab);
                    loadUpcomingActions();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        }

        // Open Decision Modal
        function openDecisionModal(callNumber) {
            $('#decision-call-number').val(callNumber);
            $('#decision-auction').prop('checked', true);
            $('#auction-date-field').show();
            $('#scrap-value-field').hide();
            
            // Set default auction date to next Monday
            const today = new Date();
            const nextMonday = new Date();
            nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7 || 7));
            $('#auction-date').val(nextMonday.toISOString().split('T')[0]);
            
            $('#scrap-value').val('0.00');
            $('#decisionModal').modal('show');
        }

        // Open Auction Modal
        function openAuctionModal(callNumber) {
            // Assuming you have an auction modal
            // For now, just redirect to decision modal
            openDecisionModal(callNumber);
        }

        // Open Scrap Modal
        function openScrapModal(callNumber) {
            // You may want to create a dedicated scrap processing modal
            // For now, just open the TR208 eligibility modal
            openTR208Assessment(callNumber);
        }

        // Run status checks
        function runStatusChecks() {
            $.ajax({
                url: '/api/check-statuses',
                method: 'POST',
                success: function(response) {
                    if (response.fixed > 0) {
                        alert(`Status check completed. Fixed ${response.fixed} vehicle statuses.`);
                    } else {
                        alert('Status check completed. No issues found.');
                    }
                    loadComplianceStatus();
                    loadUpcomingActions();
                },
                error: function(xhr) {
                    alert('Error running status checks: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                }
            });
        }

        // Fix vehicle statuses
        function fixVehicleStatuses() {
            if (confirm('This will automatically fix inconsistent vehicle statuses. Proceed?')) {
                $.ajax({
                    url: '/api/check-statuses',
                    method: 'POST',
                    success: function(response) {
                        alert(`Status correction completed. Fixed ${response.fixed} vehicle statuses.`);
                        loadComplianceStatus();
                        loadVehicles(currentTab);
                        loadUpcomingActions();
                    },
                    error: function(xhr) {
                        alert('Error fixing statuses: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error'));
                    }
                });
            }
        }

        // Create visual timeline for a vehicle
        function createVisualTimeline(vehicle) {
            const container = $('#vehicle-timeline-visual');
            container.empty();
            
            if (!vehicle.tow_date || vehicle.tow_date === 'N/A') {
                container.html('<div class="alert alert-warning">Timeline not available: Missing tow date</div>');
                return;
            }
            
            try {
                // Convert dates to JavaScript Date objects
                const towDate = new Date(vehicle.tow_date);
                const topDate = vehicle.top_form_sent_date ? new Date(vehicle.top_form_sent_date) : null;
                const tr52Date = vehicle.tr52_available_date ? new Date(vehicle.tr52_available_date) : null;
                const tr208Date = vehicle.tr208_available_date ? new Date(vehicle.tr208_available_date) : null;
                const auctionDate = vehicle.auction_date ? new Date(vehicle.auction_date) : null;
                const scrapDate = vehicle.estimated_date ? new Date(vehicle.estimated_date) : null;
                const releaseDate = vehicle.release_date ? new Date(vehicle.release_date) : null;
                
                // Calculate important dates
                const topDueDate = new Date(towDate);
                topDueDate.setDate(towDate.getDate() + 1); // 24 hours after tow
                
                const policeNotifyDate = new Date(towDate);
                policeNotifyDate.setDate(towDate.getDate() + 7); // 7 days after tow
                
                const ownerRedemptionDate = topDate ? new Date(topDate) : new Date(towDate);
                ownerRedemptionDate.setDate(ownerRedemptionDate.getDate() + 20); // 20 days after TOP
                
                const securedPartyDate = topDate ? new Date(topDate) : new Date(towDate);
                securedPartyDate.setDate(securedPartyDate.getDate() + 30); // 30 days after TOP
                
                const tr208Timeline = new Date(towDate);
                tr208Timeline.setDate(towDate.getDate() + 27); // 27 days after tow
                
                const safeAuctionDate = new Date(towDate);
                safeAuctionDate.setDate(towDate.getDate() + 40); // 40 days after tow
                
                // Create a 40-day timeline (or to release date if longer)
                const timelineEnd = releaseDate || safeAuctionDate;
                const totalDays = Math.max(40, Math.ceil((timelineEnd - towDate) / (1000 * 60 * 60 * 24)));
                
                // Create the timeline container
                const timelineHTML = `<div class="timeline-visual" style="height: 100px;"></div>`;
                container.html(timelineHTML);
                
                // Calculate positions (percentage along timeline)
                const getDayPosition = (date) => {
                    const diffDays = Math.ceil((date - towDate) / (1000 * 60 * 60 * 24));
                    return (diffDays / totalDays) * 100;
                };
                
                // Add today marker
                const today = new Date();
                if (today >= towDate && today <= timelineEnd) {
                    const todayPos = getDayPosition(today);
                    $('.timeline-visual').append(`
                        <div class="timeline-today" style="left: ${todayPos}%;"></div>
                        <div class="timeline-today-label" style="left: ${todayPos}%;">TODAY</div>
                    `);
                }
                
                // Add timeline markers
                const markers = [
                    { date: towDate, label: 'Tow Date', status: 'past', pos: 0 },
                    { date: topDueDate, label: 'TOP Due (24h)', status: topDate ? 'past' : 'critical', pos: getDayPosition(topDueDate) },
                    { date: policeNotifyDate, label: 'Police Notify (7d)', status: today > policeNotifyDate ? 'past' : 'future', pos: getDayPosition(policeNotifyDate) },
                    { date: ownerRedemptionDate, label: 'Owner Redemption (20d)', status: today > ownerRedemptionDate ? 'past' : 'future', pos: getDayPosition(ownerRedemptionDate) },
                    { date: securedPartyDate, label: 'Secured Party (30d)', status: today > securedPartyDate ? 'past' : 'future', pos: getDayPosition(securedPartyDate) },
                    { date: tr208Timeline, label: 'TR208 Timeline (27d)', status: today > tr208Timeline ? 'past' : 'future', pos: getDayPosition(tr208Timeline) },
                    { date: safeAuctionDate, label: 'Safe Auction (40d)', status: today > safeAuctionDate ? 'past' : 'future', pos: getDayPosition(safeAuctionDate) }
                ];
                
                // Add actual dates if they exist
                if (topDate) markers.push({ date: topDate, label: 'TOP Sent', status: 'past', pos: getDayPosition(topDate) });
                if (tr52Date) markers.push({ date: tr52Date, label: 'TR52 Ready', status: today > tr52Date ? 'past' : 'future', pos: getDayPosition(tr52Date) });
                if (tr208Date) markers.push({ date: tr208Date, label: 'TR208 Ready', status: today > tr208Date ? 'past' : 'future', pos: getDayPosition(tr208Date) });
                if (auctionDate) markers.push({ date: auctionDate, label: 'Auction Date', status: today > auctionDate ? 'past' : 'future', pos: getDayPosition(auctionDate) });
                if (scrapDate) markers.push({ date: scrapDate, label: 'Scrap Date', status: today > scrapDate ? 'past' : 'future', pos: getDayPosition(scrapDate) });
                if (releaseDate) markers.push({ date: releaseDate, label: 'Released', status: 'past', pos: getDayPosition(releaseDate) });
                
                // Add markers to timeline
                markers.forEach(marker => {
                    if (marker.pos >= 0 && marker.pos <= 100) {
                        $('.timeline-visual').append(`
                            <div class="timeline-marker ${marker.status}" style="left: ${marker.pos}%;">
                                ${marker.label}<br>
                                <small>${marker.date.toLocaleDateString()}</small>
                            </div>
                        `);
                    }
                });
            } catch (e) {
                console.error('Timeline creation error:', e);
                container.html(`<div class="alert alert-danger">Error creating timeline: ${e.message}</div>`);
            }
        }

        function checkScrapingProgress() {
            setInterval(() => {
                $.get('/scraping-progress', function(data) {
                    const progress = data.progress;
                    $('#progress-bar').css('width', `${progress.percentage}%`).text(`${progress.percentage}%`);
                    $('#progress-text').text(progress.is_running ? `Processing ${progress.processed}/${progress.total}: ${progress.status}` : progress.status);
                    
                    if (progress.error) {
                        $('#progress-text').html(`<span class="text-danger">${progress.error}</span>`);
                    }
                });
            }, 2000);
        }

        // Fix for vehicle loading by ensuring the API calls use the correct status names
        function loadVehicles(tab) {
            const url = tab === 'active' 
                ? `/api/vehicles?sort=${sortColumn}&direction=${sortDirection}` 
                : `/api/vehicles?status_type=${tab}&sort=${sortColumn}&direction=${sortDirection}`;
            
            console.log(`Loading vehicles with URL: ${url}`);
            
            $.get(url, function(data) {
                const tbody = $('#vehicle-table-body');
                tbody.empty();
                
                if (data.length === 0) {
                    tbody.html('<tr><td colspan="12" class="text-center">No vehicles found</td></tr>');
                    return;
                }
                
                data.forEach(vehicle => {
                    const statusClass = {
                        'New': 'status-new',
                        'TOP Generated': 'status-top',
                        'TR52 Ready': 'status-tr52',
                        'TR208 Ready': 'status-tr208',
                        'Ready for Auction': 'status-auction',
                        'Ready for Scrap': 'status-scrap',
                        'Released': 'status-released',
                        'Auctioned': 'status-released',
                        'Scrapped': 'status-released',
                        'Transferred': 'status-released'
                    }[vehicle.status] || '';
                    
                    // Create timeline indicator
                    let timelineIndicator = '';
                    if (vehicle.days_until_next_step !== undefined && vehicle.days_until_next_step !== 'N/A') {
                        const daysClass = vehicle.days_until_next_step <= 1 ? 'critical' : 
                                    vehicle.days_until_next_step <= 3 ? 'warning' : '';
                        timelineIndicator = `<span class="days-counter ${daysClass}">${vehicle.days_until_next_step} days</span>`;
                    } else if (vehicle.days_until_auction !== undefined && vehicle.days_until_auction !== 'N/A') {
                        const daysClass = vehicle.days_until_auction <= 1 ? 'critical' : 
                                    vehicle.days_until_auction <= 3 ? 'warning' : '';
                        timelineIndicator = `<span class="days-counter ${daysClass}">${vehicle.days_until_auction} days</span>`;
                    } else if (vehicle.days_since_tow !== undefined) {
                        timelineIndicator = `<span class="days-counter">${vehicle.days_since_tow} days</span>`;
                    }
                    
                    const row = `
                        <tr>
                            <td>${vehicle.towbook_call_number}</td>
                            <td>${vehicle.complaint_number || 'N/A'}</td>
                            <td>${vehicle.vin}</td>
                            <td>${vehicle.make}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.year}</td>
                            <td>${vehicle.color}</td>
                            <td>${vehicle.tow_date}</td>
                            <td>${vehicle.jurisdiction}</td>
                            <td><span class="status-label ${statusClass}">${vehicle.status}</span></td>
                            <td>${timelineIndicator}</td>
                            <td>
                                <button class="btn btn-sm btn-primary view-details" data-call-number="${vehicle.towbook_call_number}"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-secondary edit-vehicle" data-call-number="${vehicle.towbook_call_number}"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                    tbody.append(row);
                });
                
                // Add event listeners for the newly created buttons
                $('.view-details').click(function() {
                    const callNumber = $(this).data('call-number');
                    loadVehicleDetails(callNumber);
                });
                
                $('.edit-vehicle').click(function() {
                    const callNumber = $(this).data('call-number');
                    $.get(`/api/vehicles?call_number=${callNumber}`, function(data) {
                        if (data.length > 0) {
                            const vehicle = data[0];
                            $('#edit-call-number').val(vehicle.towbook_call_number);
                            $('#edit-complaint_number').val(vehicle.complaint_number);
                            $('#edit-vin').val(vehicle.vin);
                            $('#edit-make').val(vehicle.make);
                            $('#edit-model').val(vehicle.model);
                            $('#edit-year').val(vehicle.year);
                            $('#edit-color').val(vehicle.color);
                            $('#edit-plate').val(vehicle.plate);
                            $('#edit-state').val(vehicle.state);
                            $('#edit-tow_date').val(vehicle.tow_date !== 'N/A' ? vehicle.tow_date : '');
                            $('#edit-tow_time').val(vehicle.tow_time !== 'N/A' ? vehicle.tow_time : '');
                            $('#edit-requested_by').val(vehicle.requested_by !== 'N/A' ? vehicle.requested_by : vehicle.requestor !== 'N/A' ? vehicle.requestor : '');
                            $('#edit-location').val(vehicle.location !== 'N/A' ? vehicle.location : '');
                            $('#edit-jurisdiction').val(vehicle.jurisdiction !== 'N/A' ? vehicle.jurisdiction : '');
                            $('#edit-status').val(vehicle.status);
                            $('#edit-officer_name').val(vehicle.officer_name !== 'N/A' ? vehicle.officer_name : '');
                            $('#edit-case_number').val(vehicle.case_number !== 'N/A' ? vehicle.case_number : '');
                            $('#editVehicleModal').modal('show');
                        }
                    });
                });
            }).fail(function(xhr, status, error) {
                console.error("Error loading vehicles:", error);
                console.error("Response:", xhr.responseText);
                $('#vehicle-table-body').html('<tr><td colspan="12" class="text-center text-danger">Error loading vehicles. Please check console for details.</td></tr>');
            });
        }

        // Make sure to create the static/js directory and save navbar.js there
        $(document).ready(function() {
            // Create static/js directory if it doesn't exist
            $.ajax({
                url: '/static/js',
                type: 'HEAD',
                error: function() {
                    console.warn("static/js directory may not exist. Create it manually if needed.");
                }
            });
            
            // Set the user role data attribute on body for navbar.js to use
            const userRole = '{{ current_user.role }}';
            document.body.dataset.userRole = userRole;
            
            // Debugging: Log when page is loaded
            console.log("Index page loaded. Current tab:", currentTab);
        });
    </script>
    <script src="/static/js/navbar.js"></script>
</body>
</html>