{% extends "base.html" %}

{% block title %}Reports Dashboard - iTow VMS{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .reports-header {
        background: linear-gradient(135deg, #805ad5 0%, #9f7aea 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
    }
    
    .report-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #805ad5;
        transition: transform 0.2s ease;
        margin-bottom: 1.5rem;
        cursor: pointer;
    }
    
    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }
    
    .report-generator {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .report-preview {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .report-type-btn {
        border-radius: 20px;
        padding: 0.5rem 1.5rem;
        margin: 0.25rem;
        border: 2px solid #805ad5;
        background: transparent;
        color: #805ad5;
        transition: all 0.2s ease;
    }
    
    .report-type-btn.active,
    .report-type-btn:hover {
        background: #805ad5;
        color: white;
    }
    
    .schedule-card {
        background: #fef5e7;
        border: 1px solid #f6ad55;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .export-options {
        background: #ebf8ff;
        border: 1px solid #63b3ed;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .report-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-ready { background: #c6f6d5; color: #276749; }
    .status-generating { background: #bee3f8; color: #2a69ac; }
    .status-scheduled { background: #feebc8; color: #b7791f; }
    .status-error { background: #fed7d7; color: #9b2c2c; }
    
    .dashboard-section {
        margin-bottom: 3rem;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 0.5rem;
    }
    
    .custom-report-builder {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 2px dashed #cbd5e0;
    }
    
    .filter-group {
        background: #f7fafc;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .preview-loading {
        text-align: center;
        padding: 3rem;
        color: #718096;
    }
    
    .report-history-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: background-color 0.2s ease;
    }
    
    .report-history-item:hover {
        background: #f7fafc;
    }
    
    .compliance-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .compliance-pass { background: #38a169; }
    .compliance-warning { background: #d69e2e; }
    .compliance-fail { background: #e53e3e; }
</style>
{% endblock %}

{% block content %}
<div class="reports-header">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-2">
                    <i class="fas fa-file-alt"></i> Reports Dashboard
                </h1>
                <p class="mb-0">Generate, schedule, and manage comprehensive business reports</p>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Quick Report Generation -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-bolt"></i> Quick Reports
        </h2>
        
        <div class="row" id="quickReportsContainer">
            <!-- Quick report cards will be loaded here -->
        </div>
    </div>

    <!-- Custom Report Builder -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-tools"></i> Custom Report Builder
        </h2>
        
        <div class="custom-report-builder">
            <div class="row">
                <div class="col-lg-4">
                    <h5><i class="fas fa-cog"></i> Report Configuration</h5>
                    
                    <!-- Report Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Report Type</label>
                        <div id="reportTypeButtons">
                            <button type="button" class="report-type-btn active" data-type="executive">Executive Summary</button>
                            <button type="button" class="report-type-btn" data-type="operational">Operational</button>
                            <button type="button" class="report-type-btn" data-type="financial">Financial</button>
                            <button type="button" class="report-type-btn" data-type="compliance">Compliance</button>
                            <button type="button" class="report-type-btn" data-type="custom">Custom</button>
                        </div>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="filter-group">
                        <h6><i class="fas fa-calendar"></i> Date Range</h6>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="reportStartDate">
                            </div>
                            <div class="col-6">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="reportEndDate">
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setDateRange(7)">Last 7 days</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setDateRange(30)">Last 30 days</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setDateRange(90)">Last 90 days</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filter-group">
                        <h6><i class="fas fa-filter"></i> Filters</h6>
                        <div class="mb-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter" multiple>
                                <option value="new">New</option>
                                <option value="top_generated">TOP Generated</option>
                                <option value="ready_for_disposition">Ready for Disposition</option>
                                <option value="auctioned">Auctioned</option>
                                <option value="released">Released</option>
                                <option value="scrapped">Scrapped</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Jurisdiction</label>
                            <select class="form-select" id="jurisdictionFilter">
                                <option value="">All Jurisdictions</option>
                                <!-- Jurisdictions will be loaded here -->
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Vehicle Type</label>
                            <select class="form-select" id="vehicleTypeFilter">
                                <option value="">All Types</option>
                                <option value="car">Car</option>
                                <option value="truck">Truck</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="export-options">
                        <h6><i class="fas fa-download"></i> Export Options</h6>
                        <div class="mb-2">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="exportFormat">
                                <option value="pdf">PDF Report</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="csv">CSV Data</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeCharts">
                            <label class="form-check-label" for="includeCharts">
                                Include Charts and Visualizations
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeRawData">
                            <label class="form-check-label" for="includeRawData">
                                Include Raw Data
                            </label>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-play"></i> Generate Report
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="previewReport()">
                            <i class="fas fa-eye"></i> Preview Report
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="scheduleReport()">
                            <i class="fas fa-clock"></i> Schedule Report
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-8">
                    <h5><i class="fas fa-chart-bar"></i> Report Preview</h5>
                    <div class="report-preview" id="reportPreview">
                        <div class="preview-loading">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>Configure your report settings and click "Preview Report" to see a preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduled Reports -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-calendar-check"></i> Scheduled Reports
        </h2>
        
        <div class="row">
            <div class="col-lg-8">
                <div id="scheduledReportsContainer">
                    <!-- Scheduled reports will be loaded here -->
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="schedule-card">
                    <h6><i class="fas fa-plus-circle"></i> Create Schedule</h6>
                    <p class="small text-muted">Automate report generation and delivery</p>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openScheduleModal()">
                        <i class="fas fa-calendar-plus"></i> New Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report History -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-history"></i> Report History
        </h2>
        
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <input type="text" class="form-control" placeholder="Search reports..." id="reportSearchInput" style="width: 300px;">
                    </div>
                    <div>
                        <select class="form-select" id="historyTimeFilter" style="width: auto;">
                            <option value="7d">Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                            <option value="90d">Last 90 days</option>
                            <option value="1y">Last year</option>
                        </select>
                    </div>
                </div>
                
                <div id="reportHistoryContainer">
                    <!-- Report history will be loaded here -->
                </div>
                
                <nav aria-label="Report history pagination">
                    <ul class="pagination justify-content-center" id="historyPagination">
                        <!-- Pagination will be loaded here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Compliance Reports -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-shield-alt"></i> Compliance Reports
        </h2>
        
        <div class="row" id="complianceReportsContainer">
            <!-- Compliance reports will be loaded here -->
        </div>
    </div>
</div>

<!-- Schedule Report Modal -->
<div class="modal fade" id="scheduleReportModal" tabindex="-1" aria-labelledby="scheduleReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleReportModalLabel">
                    <i class="fas fa-calendar-plus"></i> Schedule Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleReportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Report Name</label>
                                <input type="text" class="form-control" id="scheduleName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Frequency</label>
                                <select class="form-select" id="scheduleFrequency" required>
                                    <option value="">Select frequency</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="scheduleStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-control" id="scheduleTime" value="09:00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email Recipients</label>
                        <textarea class="form-control" id="scheduleRecipients" rows="3" 
                                  placeholder="Enter email addresses separated by commas"></textarea>
                        <div class="form-text">Reports will be automatically sent to these email addresses</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Report Configuration</label>
                        <div class="border rounded p-3 bg-light">
                            <small class="text-muted">Current report configuration will be used</small>
                            <div id="currentConfigSummary">
                                <!-- Current configuration summary will be shown here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSchedule()">
                    <i class="fas fa-save"></i> Save Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentReportType = 'executive';
let reportHistory = [];
let scheduledReports = [];
let currentPage = 1;
const itemsPerPage = 10;

// Initialize dashboard
$(document).ready(function() {
    initializeReportsDashboard();
    loadReportData();
});

function initializeReportsDashboard() {
    setupEventHandlers();
    setDefaultDates();
    loadQuickReports();
    loadScheduledReports();
    loadReportHistory();
    loadComplianceReports();
}

function setupEventHandlers() {
    // Report type buttons
    $('.report-type-btn').click(function() {
        $('.report-type-btn').removeClass('active');
        $(this).addClass('active');
        currentReportType = $(this).data('type');
        updateReportConfiguration();
    });
    
    // Search functionality
    $('#reportSearchInput').on('input', function() {
        filterReportHistory();
    });
    
    // History time filter
    $('#historyTimeFilter').change(function() {
        loadReportHistory();
    });
}

function setDefaultDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    $('#reportStartDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
    $('#reportEndDate').val(today.toISOString().split('T')[0]);
}

function setDateRange(days) {
    const today = new Date();
    const startDate = new Date();
    startDate.setDate(today.getDate() - days);
    
    $('#reportStartDate').val(startDate.toISOString().split('T')[0]);
    $('#reportEndDate').val(today.toISOString().split('T')[0]);
}

function loadQuickReports() {
    const quickReports = [
        {
            title: 'Daily Operations Summary',
            description: 'Quick overview of today\'s vehicle processing activities',
            icon: 'fas fa-calendar-day',
            color: '#3182ce',
            type: 'daily_ops'
        },
        {
            title: 'Weekly Financial Report',
            description: 'Revenue and cost analysis for the current week',
            icon: 'fas fa-chart-line',
            color: '#38a169',
            type: 'weekly_financial'
        },
        {
            title: 'Compliance Status',
            description: 'Current compliance status and pending requirements',
            icon: 'fas fa-shield-alt',
            color: '#d69e2e',
            type: 'compliance_status'
        },
        {
            title: 'Vehicle Inventory',
            description: 'Complete inventory of all vehicles by status',
            icon: 'fas fa-warehouse',
            color: '#805ad5',
            type: 'inventory'
        }
    ];
    
    const container = $('#quickReportsContainer');
    container.empty();
    
    quickReports.forEach(function(report) {
        const card = $(`
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="report-card" onclick="generateQuickReport('${report.type}')">
                    <div class="d-flex align-items-center mb-3">
                        <i class="${report.icon}" style="color: ${report.color}; font-size: 2rem;"></i>
                        <div class="ms-3">
                            <h6 class="mb-0">${report.title}</h6>
                            <small class="text-muted">${report.description}</small>
                        </div>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download"></i> Generate
                        </button>
                    </div>
                </div>
            </div>
        `);
        container.append(card);
    });
}

function loadScheduledReports() {
    // Simulated scheduled reports data
    const schedules = [
        {
            id: 1,
            name: 'Weekly Financial Summary',
            frequency: 'weekly',
            next_run: '2024-01-08 09:00',
            recipients: ['admin@example.com', 'finance@example.com'],
            status: 'active'
        },
        {
            id: 2,
            name: 'Monthly Compliance Report',
            frequency: 'monthly',
            next_run: '2024-02-01 09:00',
            recipients: ['compliance@example.com'],
            status: 'active'
        }
    ];
    
    const container = $('#scheduledReportsContainer');
    container.empty();
    
    if (schedules.length > 0) {
        schedules.forEach(function(schedule) {
            const card = $(`
                <div class="report-history-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${schedule.name}</h6>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${schedule.frequency} - Next: ${schedule.next_run}
                            </small>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-envelope"></i> ${schedule.recipients.length} recipient(s)
                            </small>
                        </div>
                        <div>
                            <span class="report-status status-scheduled">Scheduled</span>
                            <div class="btn-group btn-group-sm ms-2">
                                <button class="btn btn-outline-secondary" onclick="editSchedule(${schedule.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSchedule(${schedule.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            container.append(card);
        });
    } else {
        container.append('<p class="text-muted">No scheduled reports. Create one using the schedule builder.</p>');
    }
}

function loadReportHistory() {
    // Simulated report history data
    const history = [
        {
            id: 1,
            name: 'Executive Summary - December 2023',
            type: 'executive',
            generated_at: '2024-01-02 10:30',
            generated_by: 'Admin User',
            size: '2.3 MB',
            format: 'PDF',
            status: 'ready'
        },
        {
            id: 2,
            name: 'Financial Report - Q4 2023',
            type: 'financial',
            generated_at: '2024-01-01 15:45',
            generated_by: 'Finance User',
            size: '1.8 MB',
            format: 'Excel',
            status: 'ready'
        },
        {
            id: 3,
            name: 'Compliance Audit - December 2023',
            type: 'compliance',
            generated_at: '2023-12-31 09:00',
            generated_by: 'System',
            size: '945 KB',
            format: 'PDF',
            status: 'ready'
        }
    ];
    
    reportHistory = history;
    renderReportHistory(history);
}

function renderReportHistory(history) {
    const container = $('#reportHistoryContainer');
    container.empty();
    
    if (history.length > 0) {
        history.forEach(function(report) {
            const statusClass = `status-${report.status}`;
            const typeIcon = getReportTypeIcon(report.type);
            
            const item = $(`
                <div class="report-history-item">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="${typeIcon}" style="font-size: 1.5rem; margin-right: 1rem; color: #805ad5;"></i>
                                <div>
                                    <h6 class="mb-1">${report.name}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> ${report.generated_by} • 
                                        <i class="fas fa-clock"></i> ${report.generated_at}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                <i class="fas fa-file"></i> ${report.format} • ${report.size}
                            </small>
                        </div>
                        <div class="col-md-3 text-end">
                            <span class="report-status ${statusClass}">${report.status.toUpperCase()}</span>
                            <div class="btn-group btn-group-sm ms-2">
                                <button class="btn btn-outline-primary" onclick="downloadReport(${report.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="shareReport(${report.id})">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteReport(${report.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            container.append(item);
        });
    } else {
        container.append('<p class="text-muted">No reports found.</p>');
    }
}

function loadComplianceReports() {
    const complianceReports = [
        {
            title: 'Lien Processing Compliance',
            description: 'Adherence to lien processing timelines and requirements',
            status: 'pass',
            score: 98.5,
            last_check: '2024-01-02'
        },
        {
            title: 'Documentation Compliance',
            description: 'Completeness of required documentation for all vehicles',
            status: 'warning',
            score: 87.2,
            last_check: '2024-01-02'
        },
        {
            title: 'Notification Requirements',
            description: 'Timely notification to lien holders and owners',
            status: 'pass',
            score: 94.8,
            last_check: '2024-01-02'
        },
        {
            title: 'Disposition Compliance',
            description: 'Proper vehicle disposition according to regulations',
            status: 'pass',
            score: 96.3,
            last_check: '2024-01-02'
        }
    ];
    
    const container = $('#complianceReportsContainer');
    container.empty();
    
    complianceReports.forEach(function(report) {
        const indicatorClass = `compliance-${report.status}`;
        
        const card = $(`
            <div class="col-lg-6 mb-3">
                <div class="report-card">
                    <div class="d-flex align-items-center mb-3">
                        <div class="compliance-indicator ${indicatorClass}"></div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${report.title}</h6>
                            <small class="text-muted">${report.description}</small>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-0">${report.score}%</h4>
                            <small class="text-muted">Score</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Last checked: ${report.last_check}</small>
                        <button class="btn btn-outline-primary btn-sm" onclick="generateComplianceReport('${report.title}')">
                            <i class="fas fa-file-alt"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>
        `);
        container.append(card);
    });
}

function updateReportConfiguration() {
    // Update the preview based on selected report type
    $('#reportPreview').html(`
        <div class="preview-loading">
            <i class="fas fa-cog fa-spin fa-2x mb-3"></i>
            <p>Loading ${currentReportType} report configuration...</p>
        </div>
    `);
    
    // Simulate configuration loading
    setTimeout(function() {
        const config = getReportTypeConfig(currentReportType);
        $('#reportPreview').html(config.preview);
    }, 1000);
}

function getReportTypeConfig(type) {
    const configs = {
        executive: {
            preview: `
                <h6>Executive Summary Report Preview</h6>
                <p class="text-muted">This report includes:</p>
                <ul class="text-muted">
                    <li>Key performance indicators</li>
                    <li>Financial summary</li>
                    <li>Operational metrics</li>
                    <li>Strategic recommendations</li>
                </ul>
            `
        },
        operational: {
            preview: `
                <h6>Operational Report Preview</h6>
                <p class="text-muted">This report includes:</p>
                <ul class="text-muted">
                    <li>Processing times and efficiency</li>
                    <li>Workflow bottlenecks</li>
                    <li>Resource utilization</li>
                    <li>Performance trends</li>
                </ul>
            `
        },
        financial: {
            preview: `
                <h6>Financial Report Preview</h6>
                <p class="text-muted">This report includes:</p>
                <ul class="text-muted">
                    <li>Revenue analysis</li>
                    <li>Cost breakdown</li>
                    <li>Profit margins</li>
                    <li>Financial forecasts</li>
                </ul>
            `
        },
        compliance: {
            preview: `
                <h6>Compliance Report Preview</h6>
                <p class="text-muted">This report includes:</p>
                <ul class="text-muted">
                    <li>Regulatory compliance status</li>
                    <li>Audit findings</li>
                    <li>Risk assessments</li>
                    <li>Corrective actions</li>
                </ul>
            `
        },
        custom: {
            preview: `
                <h6>Custom Report Preview</h6>
                <p class="text-muted">Build your own report with:</p>
                <ul class="text-muted">
                    <li>Selected data fields</li>
                    <li>Custom date ranges</li>
                    <li>Specific filters</li>
                    <li>Preferred visualizations</li>
                </ul>
            `
        }
    };
    
    return configs[type] || configs.executive;
}

function getReportTypeIcon(type) {
    const icons = {
        executive: 'fas fa-chart-line',
        operational: 'fas fa-cogs',
        financial: 'fas fa-dollar-sign',
        compliance: 'fas fa-shield-alt',
        custom: 'fas fa-tools'
    };
    
    return icons[type] || 'fas fa-file-alt';
}

function generateReport() {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    
    // Collect report configuration
    const config = {
        type: currentReportType,
        startDate: $('#reportStartDate').val(),
        endDate: $('#reportEndDate').val(),
        status: $('#statusFilter').val(),
        jurisdiction: $('#jurisdictionFilter').val(),
        vehicleType: $('#vehicleTypeFilter').val(),
        format: $('#exportFormat').val(),
        includeCharts: $('#includeCharts').is(':checked'),
        includeRawData: $('#includeRawData').is(':checked')
    };
    
    // Simulate report generation
    setTimeout(function() {
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Show success message
        showToast('success', 'Report generated successfully!');
        
        // Refresh report history
        loadReportHistory();
    }, 3000);
}

function previewReport() {
    $('#reportPreview').html(`
        <div class="preview-loading">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Generating report preview...</p>
        </div>
    `);
    
    // Simulate preview generation
    setTimeout(function() {
        $('#reportPreview').html(`
            <h6>${currentReportType.charAt(0).toUpperCase() + currentReportType.slice(1)} Report Preview</h6>
            <div class="row">
                <div class="col-md-6">
                    <canvas id="previewChart" width="300" height="200"></canvas>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Total Vehicles</td><td>247</td></tr>
                            <tr><td>Processed</td><td>189</td></tr>
                            <tr><td>Pending</td><td>58</td></tr>
                            <tr><td>Revenue</td><td>$45,230</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">This is a preview based on current filters and date range.</small>
            </div>
        `);
        
        // Create a simple preview chart
        const ctx = document.getElementById('previewChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
                datasets: [{
                    label: 'Sample Data',
                    data: [12, 19, 3, 5, 2],
                    backgroundColor: 'rgba(128, 90, 213, 0.6)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }, 1500);
}

function scheduleReport() {
    openScheduleModal();
}

function openScheduleModal() {
    // Update current configuration summary
    $('#currentConfigSummary').html(`
        <small>
            <strong>Type:</strong> ${currentReportType}<br>
            <strong>Date Range:</strong> ${$('#reportStartDate').val()} to ${$('#reportEndDate').val()}<br>
            <strong>Format:</strong> ${$('#exportFormat').val()}
        </small>
    `);
    
    // Set default start date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    $('#scheduleStartDate').val(tomorrow.toISOString().split('T')[0]);
    
    $('#scheduleReportModal').modal('show');
}

function saveSchedule() {
    // Validate form
    const name = $('#scheduleName').val();
    const frequency = $('#scheduleFrequency').val();
    const startDate = $('#scheduleStartDate').val();
    const time = $('#scheduleTime').val();
    
    if (!name || !frequency || !startDate || !time) {
        showToast('error', 'Please fill in all required fields');
        return;
    }
    
    // Save schedule (simulated)
    showToast('success', 'Report schedule created successfully!');
    $('#scheduleReportModal').modal('hide');
    
    // Refresh scheduled reports
    loadScheduledReports();
}

function generateQuickReport(type) {
    showToast('info', `Generating ${type} report...`);
    
    // Simulate quick report generation
    setTimeout(function() {
        showToast('success', 'Quick report generated successfully!');
        loadReportHistory();
    }, 2000);
}

function generateComplianceReport(title) {
    showToast('info', `Generating ${title} compliance report...`);
    
    // Simulate compliance report generation
    setTimeout(function() {
        showToast('success', 'Compliance report generated successfully!');
        loadReportHistory();
    }, 2000);
}

function downloadReport(id) {
    showToast('info', 'Downloading report...');
    // Simulate download
}

function shareReport(id) {
    showToast('info', 'Sharing options opened');
    // Open sharing modal
}

function deleteReport(id) {
    if (confirm('Are you sure you want to delete this report?')) {
        showToast('success', 'Report deleted successfully');
        loadReportHistory();
    }
}

function editSchedule(id) {
    showToast('info', 'Edit schedule functionality');
    // Open edit modal
}

function deleteSchedule(id) {
    if (confirm('Are you sure you want to delete this schedule?')) {
        showToast('success', 'Schedule deleted successfully');
        loadScheduledReports();
    }
}

function filterReportHistory() {
    const searchTerm = $('#reportSearchInput').val().toLowerCase();
    const filtered = reportHistory.filter(report => 
        report.name.toLowerCase().includes(searchTerm) ||
        report.type.toLowerCase().includes(searchTerm) ||
        report.generated_by.toLowerCase().includes(searchTerm)
    );
    
    renderReportHistory(filtered);
}

function loadReportData() {
    // Load additional data as needed
}

function showToast(type, message) {
    // Simple toast notification
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const toast = $(`
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').append(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(function() {
        toast.alert('close');
    }, 3000);
}
</script>
{% endblock %}
