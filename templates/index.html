<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Corrected viewport meta tag -->
    <title>iTow Impound Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; min-height: 100vh; background-color: #f4f7f6; }
        .navbar-brand img { height: 30px; margin-right: 10px; }
        .sidebar { width: 260px; background-color: #343a40; color: #fff; padding: 15px; display: flex; flex-direction: column; position: fixed; height: 100%; overflow-y: auto; }
        .sidebar a { color: #adb5bd; text-decoration: none; padding: 12px 15px; display: block; border-radius: 4px; margin-bottom: 5px; transition: background-color 0.2s, color 0.2s; }
        .sidebar a:hover { background-color: #495057; color: #fff; }
        .sidebar a.active { background-color: #007bff; color: #fff; font-weight: bold; }
        .sidebar a i { margin-right: 10px; width: 20px; text-align: center; } /* Ensure icons align nicely */
        .sidebar hr.bg-light { border-top: 1px solid #495057; }
        .content { margin-left: 260px; flex-grow: 1; padding: 20px; background-color: #fff; /* Added background for content area */ } 
        .vehicle-table th { background-color: #e9ecef; cursor: pointer; }
        .vehicle-table th.sorted-asc::after { content: " \\25B2"; } /* Up arrow */
        .vehicle-table th.sorted-desc::after { content: " \\25BC"; } /* Down arrow */
        .status-label { padding: 0.3em 0.6em; font-size: 0.85em; border-radius: 0.25rem; color: #fff; display: inline-block; white-space: nowrap; }
        .status-new { background-color: #007bff; }
        .status-top-generated, .status-top_generated { background-color: #17a2b8; } /* Adjusted for consistency */
        .status-tr52-ready, .status-tr52_ready { background-color: #28a745; }
        .status-tr208-ready, .status-tr208_ready { background-color: #20c997; } /* Different green for distinction */
        .status-ready-for-auction, .status-ready_for_auction { background-color: #ffc107; color: #212529; }
        .status-ready-for-scrap, .status-ready_for_scrap { background-color: #fd7e14; } /* Orange for scrap */
        .status-released { background-color: #6c757d; }
        .status-auctioned { background-color: #e83e8c; } /* Pink/Magenta for Auctioned */
        .status-scrapped { background-color: #dc3545; } /* Red for Scrapped */
        .status-transferred { background-color: #6610f2; } /* Indigo for Transferred */
        .modal-body pre { background-color: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        .photo-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .photo-preview img { max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
        .timeline { list-style: none; padding: 0; position: relative; }
        .timeline-item { margin-bottom: 20px; padding-left: 30px; position: relative; }
        .timeline-item::before { content: ''; background-color: #007bff; width: 12px; height: 12px; border-radius: 50%; position: absolute; left: 0; top: 5px; border: 2px solid #fff; box-shadow: 0 0 0 3px #007bff; }
        .timeline-item .badge { font-size: 0.9em; }
        .stat-card { border: 1px solid #dee2e6; border-radius: 0.3rem; padding: 15px; margin-bottom: 15px; transition: box-shadow 0.2s; }
        .stat-card:hover { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .stat-card h3 { font-size: 1.2rem; margin-bottom: 5px; color: #495057; }
        .stat-card .stat-value { font-size: 1.8rem; font-weight: bold; color: #007bff; }
        .notification-badge { position: absolute; top: 8px; right: 8px; padding: 0.25em 0.5em; font-size: 0.75em; font-weight: bold; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.375rem; background-color: #dc3545; color: white; }
        .sidebar a .notification-badge { position: static; margin-left: 8px; } /* Badge for sidebar notification link */
        .contacts-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .contact-card { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 5px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .contact-card h5 { margin-bottom: 10px; color: #007bff; }
        .document-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .document-item:last-child { border-bottom: none; }
        .document-item i { margin-right: 10px; color: #007bff; }
        .document-date { font-size: 0.8em; color: #6c757d; margin-left: auto; }
        .notification-item { padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; border-radius: 4px; background-color: #fff; }
        .notification-item.urgent { border-left: 5px solid #dc3545; }
        .note-field { margin-top: 15px; }
        .action-links a { margin-right: 8px; color: #007bff; text-decoration: none; }
        .action-links a:hover { text-decoration: underline; }
        .days-counter { font-weight: bold; }
        .days-counter.critical { color: #dc3545; }
        .days-counter.warning { color: #ffc107; }
        @media (max-width: 768px) { 
            .sidebar { width: 100%; height: auto; position: relative; flex-direction: row; overflow-x: auto; white-space: nowrap; }
            .sidebar a { display: inline-block; padding: 10px; }
            .content { margin-left: 0; }
            .navbar-brand span { display: none; } /* Hide "iTow Manager" text on small screens for navbar brand */
        }
        .fullscreen-photo { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1060; /* Higher than modals */ }
        .fullscreen-photo img { max-width: 90%; max-height: 90%; border-radius: 5px; }
        .fullscreen-photo .close-btn { position: absolute; top: 20px; right: 30px; font-size: 2rem; color: #fff; cursor: pointer; }

        /* Timeline visualization styles */
        .timeline-visual { display: flex; align-items: center; height: 50px; background-color: #e9ecef; border-radius: 4px; padding: 0 10px; margin-bottom: 15px; overflow-x: auto; }
        .timeline-marker { position: relative; width: 10px; height: 10px; background-color: #adb5bd; border-radius: 50%; margin: 0 5px; /* Reduced margin */ display: flex; flex-direction: column; align-items: center; }
        .timeline-marker .marker-label { font-size: 0.7em; white-space: nowrap; position: absolute; top: 15px; transform: translateX(-50%); left: 50%; display: none; /* Hidden by default, shown on hover/active */ }
        .timeline-marker:hover .marker-label { display: block; }
        .timeline-marker.past { background-color: #28a745; } /* Green for past/completed */
        .timeline-marker.current { background-color: #007bff; transform: scale(1.5); } /* Blue and larger for current */
        .timeline-marker.future { background-color: #ffc107; } /* Yellow for future */
        .timeline-marker.critical { background-color: #dc3545; animation: pulse 1.5s infinite; } /* Red and pulsing for critical/overdue */
        .timeline-today { position: absolute; height: 100%; width: 2px; background-color: #dc3545; /* Red line for today */ z-index: 1; }
        .timeline-today-label { position: absolute; top: -20px; background-color: #dc3545; color: white; padding: 2px 5px; font-size: 0.7em; border-radius: 3px; z-index: 1; }
        .status-released, .status-released.badge { background-color: #6c757d !important; color: #fff !important; } /* Ensure released status is distinct */
        
        #scraping-status-container { margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; }
        #scraping-status { font-weight: bold; margin-bottom: 5px; }
        #scraping-progress { width: 100%; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); } }
    </style>
    <!-- JavaScript for dynamic content loading and interactions will be in separate files or at the end of body -->
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <a class="navbar-brand text-white d-flex align-items-center" href="/">
            <img src="/static/logo.png" alt="iTow Logo"> 
            <span>iTow Manager</span>
        </a>
        <hr class="bg-light">
        <a href="#" data-tab="dashboard" class="active" data-bs-toggle="tooltip" title="Overview of your impound operations"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="#" data-tab="active" data-bs-toggle="tooltip" title="Vehicles currently being processed (New to Ready for Scrap/Auction)"><i class="fas fa-car"></i> Active Vehicles</a>
        <a href="#" data-tab="New"><i class="fas fa-plus-circle"></i> New</a>
        <a href="#" data-tab="TOP_Generated"><i class="fas fa-file-signature"></i> TOP Generated</a>
        <a href="#" data-tab="TR52_Ready"><i class="fas fa-envelope-open-text"></i> TR52 Ready</a>
        <a href="#" data-tab="TR208_Ready"><i class="fas fa-stamp"></i> TR208 Ready</a>
        <a href="#" data-tab="Ready_for_Auction"><i class="fas fa-gavel"></i> Ready for Auction</a>
        <a href="#" data-tab="Ready_for_Scrap"><i class="fas fa-recycle"></i> Ready for Scrap</a>
        <a href="#" data-tab="completed" data-bs-toggle="tooltip" title="Vehicles no longer active (Released, Auctioned, Scrapped, Transferred)"><i class="fas fa-archive"></i> Completed Vehicles</a>
        <a href="#" data-tab="notifications"><i class="fas fa-bell"></i> Notifications <span id="notification-count" class="badge bg-danger ms-1 d-none">0</span></a>
        <a href="#" data-tab="contacts"><i class="fas fa-address-book"></i> Jurisdiction Contacts</a>
        <a href="#" data-tab="reports" data-bs-toggle="tooltip" title="Generate and view reports"><i class="fas fa-chart-line"></i> Reports</a>
        <a href="#" data-tab="statistics"><i class="fas fa-chart-pie"></i> Statistics</a> <!-- Changed icon for variety -->
        <a href="#" data-tab="compliance"><i class="fas fa-shield-alt"></i> Compliance Check</a>
        <a href="#" data-tab="scraper" data-bs-toggle="tooltip" title="Import data from TowBook"><i class="fas fa-cloud-download-alt"></i> TowBook Import</a>
        <hr class="bg-light">
        <a href="#" data-tab="profile"><i class="fas fa-user-cog"></i> Profile</a>
        <a href="#" data-tab="logs"><i class="fas fa-clipboard-list"></i> System Logs</a>
        <a href="/logout" data-tab="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
        <!-- Admin links will be added dynamically by navbar.js if the user is an admin -->
    </div>
    
    <!-- Main Content -->
    <div class="content" id="main-content">
        <!-- Content will be loaded here by JavaScript -->
        <div class="container-fluid">
            <h2 id="current-tab-title">Dashboard</h2> <!-- Default title -->
            <div id="dynamic-content-area">
                <!-- Actual content for tabs goes here -->
                <p>Welcome to iTow Impound Manager. Select an option from the sidebar to get started.</p>
            </div>
        </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1" aria-labelledby="addVehicleModalLabel" aria-hidden="true">
        <!-- Modal content will be loaded or defined here -->
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editVehicleModal" tabindex="-1" aria-labelledby="editVehicleModalLabel" aria-hidden="true">
        <!-- Modal content will be loaded or defined here -->
    </div>

    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="vehicleDetailsModal" tabindex="-1" aria-labelledby="vehicleDetailsModalLabel" aria-hidden="true">
        <!-- Modal content will be loaded or defined here -->
    </div>

    <!-- Add Contact Modal -->
    <div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
        <!-- Modal content will be loaded or defined here -->
    </div>

    <!-- Import Vehicles Modal (was ScrapeModal) -->
    <div class="modal fade" id="importVehiclesModal" tabindex="-1" aria-labelledby="importVehiclesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importVehiclesModalLabel">Import Vehicles from TowBook</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scrapeForm">
                        <div class="mb-3">
                            <label for="towbookUsername">TowBook Username</label>
                            <input type="text" class="form-control" id="towbookUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="towbookPassword">TowBook Password</label>
                            <input type="password" class="form-control" id="towbookPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="scrapeStartDate">Start Date</label>
                            <input type="date" class="form-control" id="scrapeStartDate" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="scrapeEndDate">End Date</label>
                            <input type="date" class="form-control" id="scrapeEndDate" name="end_date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Start Import</button>
                    </form>
                    <div id="scraping-status-container" class="mt-3" style="display: none;">
                        <div id="scraping-status">Importing data...</div>
                        <progress id="scraping-progress" class="w-100" value="0" max="100"></progress>
                        <div id="scraping-message" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Release Notice Modal -->
    <div class="modal fade" id="releaseNoticeModal" tabindex="-1" aria-labelledby="releaseNoticeModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- Decision Modal -->
    <div class="modal fade" id="decisionModal" tabindex="-1" aria-labelledby="decisionModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- Upload TR52 Modal -->
    <div class="modal fade" id="uploadTR52Modal" tabindex="-1" aria-labelledby="uploadTR52ModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- Send Notification Modal -->
    <div class="modal fade" id="sendNotificationModal" tabindex="-1" aria-labelledby="sendNotificationModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- Storage Fees Modal -->
    <div class="modal fade" id="storageFeesModal" tabindex="-1" aria-labelledby="storageFeesModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- TR208 Eligibility Assessment Modal -->
    <div class="modal fade" id="tr208EligibilityModal" tabindex="-1" aria-labelledby="tr208EligibilityModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- TR208 Status Update Modal -->
    <div class="modal fade" id="tr208StatusModal" tabindex="-1" aria-labelledby="tr208StatusModalLabel" aria-hidden="true">
        <!-- ... -->
    </div>

    <!-- Full-screen Photo Viewer -->
    <div id="fullscreen-photo-container" class="fullscreen-photo d-none" onclick="this.classList.add('d-none');">
        <span class="close-btn" onclick="document.getElementById('fullscreen-photo-container').classList.add('d-none');">&times;</span>
        <img id="fullscreen-photo-image" src="" alt="Full Screen Photo">
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <!-- Toasts will be appended here by JavaScript -->
    </div>

    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chart.js for statistics and reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="/static/js/main.js"></script> <!-- Main application logic, tab handling -->
    <script src="/static/js/modals.js"></script> <!-- Logic for modals -->
    <script src="/static/js/notifications.js"></script> <!-- Handles toast notifications -->
    <script src="/static/js/scraper_ui.js"></script> <!-- UI logic for TowBook Importer -->
    <script src="/static/js/reports.js"></script> <!-- Logic for fetching and displaying reports -->
    <!-- Removed navbar.js as its functionality can be part of main.js or specific component JS -->
    <!-- Removed inline script for scraping progress, moved to scraper_ui.js -->
    <!-- Removed scraping status/progress elements from here, should be part of ImportVehiclesModal or a dedicated status area -->

    <script>
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    </script>
    
    <!-- Diagnostic script to verify data loading -->
    <script>
        // Run diagnostic check when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if the user is logged in and the page is fully loaded
            setTimeout(runDiagnostics, 1000); // Give a second for other scripts to load
        });
        
        function runDiagnostics() {
            console.log('[DIAG] Running diagnostics...'); // Log prefix added
            try {
                console.log('[DIAG] Creating diagnostic area element...');
                const diagArea = document.createElement('div');
                diagArea.id = 'diagnostic-area'; // ID is important
                diagArea.className = 'alert alert-info';
                diagArea.innerHTML = '<strong>Loading diagnostic information...</strong>';
                console.log('[DIAG] Diagnostic area element created.');

                console.log('[DIAG] Getting content area...');
                const contentArea = document.getElementById('dynamic-content-area');
                if (contentArea) {
                    console.log('[DIAG] dynamic-content-area found. Prepending diagnostic area.');
                    contentArea.prepend(diagArea);
                } else {
                    console.warn('[DIAG] dynamic-content-area NOT found. Trying to prepend to main-content.');
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        console.log('[DIAG] main-content found. Prepending diagnostic area.');
                        mainContent.prepend(diagArea);
                    } else {
                        console.error('[DIAG] CRITICAL: Neither dynamic-content-area nor main-content found. Cannot display diagnostics.');
                        // If we can't even add the diagArea, further diagnostics are likely to fail or be invisible.
                        // Consider just stopping here or logging to a more persistent place if possible.
                        return; 
                    }
                }
                console.log('[DIAG] Diagnostic area prepended.');

                console.log('[DIAG] Fetching /api/diagnostic...');
                fetch('/api/diagnostic')
                    .then(response => {
                        console.log('[DIAG] Received response from /api/diagnostic. Status:', response.status);
                        if (!response.ok) {
                            throw new Error(`[DIAG] HTTP error! Status: ${response.status} for /api/diagnostic`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DIAG] Successfully fetched and parsed /api/diagnostic data.');
                        updateDiagnosticArea(data, null);
                        
                        console.log('[DIAG] Fetching /api/vehicles for diagnostics...');
                        return fetch('/api/vehicles');
                    })
                    .then(response => {
                        console.log('[DIAG] Received response from /api/vehicles. Status:', response.status);
                        if (!response.ok) {
                            throw new Error(`[DIAG] HTTP error! Status: ${response.status} for /api/vehicles`);
                        }
                        return response.json();
                    })
                    .then(vehicles => {
                        console.log('[DIAG] Successfully fetched and parsed /api/vehicles data for diagnostics.');
                        const diagAreaForVehicles = document.getElementById('diagnostic-area');
                        if (diagAreaForVehicles) {
                            diagAreaForVehicles.innerHTML += `
                                <div class="mt-2">
                                    <strong>Vehicles API test (diagnostic):</strong> Success! Found ${vehicles.length || 'unknown number of'} vehicles.
                                </div>
                            `;
                            console.log('[DIAG] Updated diagnostic area with vehicle count.');
                        } else {
                            console.warn('[DIAG] diagnostic-area not found when trying to update with vehicle count.');
                        }
                    })
                    .catch(error => {
                        console.error('[DIAG] Error in diagnostic fetch chain:', error);
                        updateDiagnosticArea(null, error);
                    });
            } catch (e) {
                console.error('[DIAG] Synchronous error in runDiagnostics:', e);
                // Attempt to display this error in the diagnostic area if it exists, or body
                let diagArea = document.getElementById('diagnostic-area');
                if (!diagArea) {
                    // If diagArea itself couldn't be created/appended, try to put error somewhere visible
                    diagArea = document.createElement('div');
                    diagArea.className = 'alert alert-danger';
                    diagArea.innerHTML = `<strong>Critical Diagnostic Script Error:</strong> ${e.message}`;
                    const mainContent = document.getElementById('main-content') || document.body;
                    mainContent.prepend(diagArea);
                } else {
                     diagArea.className = 'alert alert-danger';
                     diagArea.innerHTML = `<strong>Diagnostic Script Error:</strong> ${e.message}<br><small>See console for more details.</small>`;
                }
            }
        }
        
        function updateDiagnosticArea(data, error) {
            console.log('[DIAG] updateDiagnosticArea called.');
            const diagArea = document.getElementById('diagnostic-area');
            if (!diagArea) {
                console.error('[DIAG] CRITICAL: diagnostic-area element not found in updateDiagnosticArea.');
                return;
            }
            
            if (error) {
                console.error('[DIAG] Updating diagnostic area with error:', error.message);
                diagArea.className = 'alert alert-danger';
                diagArea.innerHTML = `
                    <strong>Diagnostic Error:</strong> ${error.message}<br>
                    <small>See console for more details.</small>
                `;
                return;
            }
            
            console.log('[DIAG] Updating diagnostic area with success data.');
            diagArea.className = 'alert alert-success';
            diagArea.innerHTML = `
                <h5>Database Diagnostic</h5>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Database Path:</strong> ${data.database_path}</p>
                <p><strong>Tables:</strong> ${data.tables.join(', ')}</p>
                <p><strong>Records:</strong> 
                   Vehicles: ${data.counts.vehicles}, 
                   Contacts: ${data.counts.contacts}, 
                   Notifications: ${data.counts.notifications}
                </p>
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('sample-data').classList.toggle('d-none')">
                    Toggle Sample Data
                </button>
                <div id="sample-data" class="d-none mt-2">
                    <pre style="max-height: 200px; overflow: auto;">${JSON.stringify(data.sample_vehicle, null, 2)}</pre>
                </div>
                <p class="mt-2"><small>If data shows correctly here but is not appearing in the application, the issue may be with the main application code's data fetching or rendering logic.</small></p>
            `;
        }
    </script>
</body>
</html>